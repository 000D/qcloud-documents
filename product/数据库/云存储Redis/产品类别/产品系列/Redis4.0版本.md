

### Redis4.0简介
Redis4.0版本是一个全新的Redis引擎版本，4.0版本将采用原生的分布式架构，通过一个产品形态支持单机、主从、集群以及多副本集，支持垂直和水平扩容和缩容，做到最大的灵活性。Redis4.0支持水平方向1～128分片的扩展，垂直方向支持0～5个副本集的扩展<br>
![](https://main.qcloudimg.com/raw/a5dc658ec13ce6f298f0e67621a311cc.png)

### 4.0版本规格
- 分片规格：0.25、1、2、4、8、12、16、20、24、28、32（GB）；<br>
- 分片数量：1、3、5、8、12、16、24、32、40、48、64、80、96、128；<br>
- 副本数量：0、1、2、3、4、5；<br>

**集群模式**：当分片数大于1时，Redis自动启用集群模式，集群模式支持的最小分片规格为4GB，集群模式对于一些跨分片的命令进行了有限的支持，具体请看兼容性介绍；<br>
**副本说明**：
- 副本数=0，Redis将不提供数据高可靠保证，HA系统监测到节点故障后，会立即启用一个新节点提供服务（**该节点无数据**）;
- 副本数=1，Redis将提供数据主从实时热备，提供数据高可靠和高可用，HA系统监测到节点故障后，会将请求切换到从节点，并且新增一个从节点加入到系统；
- 副本数>1，Redis将提供数据主从实时热备，并且提供从节点只读功能；



### 4.0版本特点

 - **高度的灵活性** <br>
社区版Redis4.0支持最小的一个节点到最大128个节点的水平扩容和缩容，支持垂直的0个副本集到5个副本集的扩容和缩容，通过一个实例的调整支持多种应用场景；
 - **极致的系统可用性** <br>
社区版Redis4.0的水平方向（分片数量）和垂直方向（副本数量）的扩容、缩容对业务完全无感知，做到最大的系统可用性，云数据库Redis对原生版本进行了优化，支持最小1个分片，系统可以做到从1个分片到128分片的扩容和缩容；
- **高度的兼容性**
社区版Redis4.0在应用场景中，支持社区版原生Cluster的使用场景，兼容Jedis等智能客户端使用场景，兼容Codis使用场景；

### 适用场景

 - **纯缓存场景** <br>
通过配置0个副本集，Redis4.0提供单机版本的Redis服务，单副本版本只有一个数据库节点，节点出现故障时，系统会重新拉起一个 Redis 进程（**没有数据**），当节点故障业务自动切换完成后，应用程序需要将数据重新预热，以免对后端数据库产生访问压力冲击。
注意：由于单副本模式不能提供数据可靠性，节点故障后需要业务进行预热，如果是对数据可靠性要求较高的敏感性业务，不建议使用单副本版，可选用双副本高可用版。

 - **主从高可用场景**  <br>
通过选择单个节点并为节点选择1个副本集，从而达到主从高可用，提供双机热备，故障自动切换的能力，保证Redis服务的高可用和高可用；

 - **读写分离场景**  <br>
当配置的节点副本数大于1个时，云数据库Redis将自动提供读写分离能力，在垂直层面提单节点读性能扩充，最大支持5个副本集，支持配置主节点以及各副本节点的读访问权重；
 
 - **多分片高性能场景**  <br>
 当配置的节点数大于1分片时，云数据库Redis将自动启动分配模式，通过将不同的Key分配到多个节点达到水平扩充系统性能的能力；
 


### 集群模式限制
- 当选择分片数大于1分片时，系统默认启用集群模式，数据将自动Hash分片，集群模式暂时不提供小于4GB的规格；
- 社区版4.0启用集群模式下，Redis对命令对支持情况分为**支持**、**有限支持**、**自定义命令**、**不支持**，对于不支持的命令系统将返回错误如下：
	```
	select 1
	(error) ERR unknown command 'select'
	```
- **不支持的命令**：
  - Redis4.0暂时不支持多DB，因为它们可能会对性能产生负面影响。我们建议使用专用数据库。以下命令被阻止，并在执行时产生错误：
    - MOVE
    - SELECT
    - SWAPDB
   - 数据持久性和备份通过控制台来管理，所以相关的命令将不支持：
     - BGREWRITEAOF
     - BGSAVE
     - LASTSAVE
  - 系统的复制和高可用由云数据库Redis后台统一管理，对他对操作可能带来稳定性对风险，所以以下命令将不支持：
    - REPLCONF
    - SLAVEOF
    - SYNC / PSYNC
   - 事务相关的命令云数据库Redis会在2018年8月版本支持，暂时不支持事务相关命令：
     - MULTI
     - EXEC
     - DISCARD
     - UNWATCH
  - 其他不支持的命令：
    -   CONFIG
    -   DEBUG 
    -   PFDEBUG
    -   OBJECT
    -   SHUTDOWN
    -   CLIENT
    -   MONITOR
    -   COMMAND
    -   SCRIPT-DEBUG
    -   LATENCY
    -  READONLy
	- TIME
	- WAIT
	- MODULE
	- DBSIZE
- **有限支持的命令**，
  - 为了兼容Jedis cluster的使用场景，云数据库Redis对Cluster 支持命令返回对IP列表进行了修改，返回信息中每个节点的IP地址为我们的实例的VIP。
    - CLUSTER NODES
    - CLUSTER SLOT 
   - 跨Slot命令支持，第一期我们将不支持跨Slot执行的命令，跨Slot操作的命令版本，将在后续推出，当出现不支持情况系统会返回如下错误：
     ```
     (error) CROSSSLOT Keys in request don't hash to the same slot
     ```
     相关命令列表如下：
       - DEL
       - UNLINK
     - EXISTS
     - MGET
     - BRPOP
     - BLPOP
     - SINTER
     - STNTERSTORE
     - SUNION
     - SDIFF
     - SDIFFSTORE
     - MSET
     - MSETNX
     - PFCOUNT
     - PFMERGE
     
- **自定义命令**，云数据Redis4.0通过VIP封装，在集群模式下提供了单机版的使用体验，对业务的使用带来的极大的便利，但是对运维带来了一定不透明，因此通过自定义命令来弥补这块空缺，支持集群中每个节点的访问，支持方式为在原有命令的参数列表最右边新增一个参数【节点ID】，COMMAND arg1 arg2 ... [节点ID]，节点ID通过命令cluster nodes获取，或者在控制台中获取：
  ```
	1.1.1.1:2000> cluster nodes
	25b21f1836026bd49c52b2d10e09fbf8c6aa1fdc 10.0.0.15:6379@11896 slave 36034e645951464098f40d339386e9d51a9d7e77 0 1531471918205 1 connected
	da6041781b5d7fe21404811d430cdffea2bf84de 10.0.0.15:6379@11170 master - 0 1531471916000 2 connected 10923-16383
	36034e645951464098f40d339386e9d51a9d7e77 10.0.0.15:6379@11541 myself,master - 0 1531471915000 1 connected 0-5460
	53f552fd8e43112ae68b10dada69d3af77c33649 10.0.0.15:6379@11681 slave da6041781b5d7fe21404811d430cdffea2bf84de 0 1531471917204 3 connected
	18090a0e57cf359f9f8c8c516aa62a811c0f0f0a 10.0.0.15:6379@11428 slave ef3cf5e20e1a7cf5f9cc259ed488c82c4aa17171 0 1531471917000 2 connected
	ef3cf5e20e1a7cf5f9cc259ed488c82c4aa17171 10.0.0.15:6379@11324 master - 0 1531471916204 0 connected 5461-10922

	原生命令：
	info server
	自定义命令:
	info server ef3cf5e20e1a7cf5f9cc259ed488c82c4aa17171
  ```
   自定义命令列表：
	 - INFO	 
	 - MEMORY
	 - SLOWLOG
	 - KEYS （支持hashtag，优先匹配hashtag）
	 - SCAN（支持hashtag，优先匹配hashtag）
- **支持的命令**
  社区版4.0除了以上的命令以外，其他命令都支持；

