此篇文章主要介绍CTSDB中常用查询关键字的使用，并给出简单JSON示例。所有示例使用的metric结构如下所示：<br>

    {
	    "ctsdb_test" : {
	      "tags" : {
	        "region" : "string"
	      },
	      "time" : {
	        "name" : "timestamp",
	        "format" : "epoch_millis"
	      },
	      "fields" : {
	        "cpuUsage" : "float",
	        "diskUsage" : "string",
	        "dcpuUsage" : "integer"
	      },
	      "options" : {
	        "expire_day" : 7,
	        "refresh_interval" : "10s",
	        "number_of_shards" : 5
	      }
	    }
	}

## Query ##
查询体中的query关键字主要用于通过Query DSL(Domain Specific Language)来定义查询条件。
### 1.Range ###
Range即区间查询，Range查询支持的字段类型包括string、long、integer、short、double、float、date。Range查询可包含的参数如下表所示：

| 参数名称        | 描述       |
|---------|---------|
|      gte   |    大于或等于    |
|      gt   |     大于        |
|      lte   |    小于或等于   |
|      lt   |     小于        |
> 注意：当Range查询涉及时间类型时，可通过format参数来指定时间格式。具体时间格式请参考[新建 metric](https://cloud.tencent.com/document/product/652/13604)。<br>

时间范围查询的JSON示例：<br>

    GET /ctsdb_test/_search
	{
		"query": {
			"range": {
				"timestamp": {
					"gte": "01/01/2018",
					"lte": "03/01/2018",
					"format": "MM/dd/yyyy"
				  }
			  }
		  }
	 }
数字范围查询JSON示例：<br>

	GET /ctsdb_test/_search
	{
		"query": {
			"range": {
				"cpuUsage": {
					"gte": 1.0,
					"lte": 10.0
				}
			}
		}
	}    
### 2.Bool ###
Bool查询用于组合多个查询条件，常用于复合查询，常见的用于Bool查询的条件有filter、must_not、should。为提高查询性能，请务必加上time字段的range查询，且time字段，不论查询时以何种方式写入，返回值统一为epoch_millis格式。query-bool-filter的组合形式可显著提升查询性能，建议尽量采用这种查询方式<br>AND条件JSON示例说明

    GET /ctsdb_test/_search
	{
  	"query": {
	    "bool": {
	      "filter": [
	        {
	          "range": {
	            "timestamp": {
	              "format": "yyyy-MM-dd HH:mm:ss",
	              "gte": "2017-11-06 23:00:00",
	              "lt": "2018-03-06 23:05:00"
	            }
	
	          }
	        },
	        {
	          "term": {
	            "region": "sh"
	          }
	        },
	        {
	          "term": {
	            "cpuUsage": "2.0"
	          }
	        }
	      ]
	    }
	  },
  	 "docvalue_fields": [
	    "cpuUsage",
	    "timestamp"
  	  ]
	}
> 注意：此查询条件类似于timestamp>='2017-11-06 23:00:00' AND timestamp<'2018-03-06 23:05:00' AND region=sh AND cpuUsage=2.0。<br>

OR条件JSON示例说明<br>

    GET /ctsdb_test/_search
	{
  	"query": {
	    "bool": {
	      "filter": [
	        {
	          "range": {
	            "timestamp": {
	              "format": "yyyy-MM-dd HH:mm:ss",
	              "gte": "2017-11-06 23:00:00",
	              "lt": "2018-11-06 23:05:00"
	            }
	          }
	        },
	        {
	          "term": {
	            "region": "gz"
	          }
	        }
	      ],
	      "should": [
	        {
	          "term": {
	            "cpuUsage": "2.0"
	          }
	        },
	        {
	          "term": {
	            "cpuUsage": "2.5"
	          }
	        }
	      ],
	      "minimum_should_match": 1
	    }
  	},
  	"docvalue_fields": [
	    "cpuUsage",
	    "timestamp"
  	]
	}
> 注意：此查询条件类似于timestamp>='2017-11-06 23:00:00' AND timestamp<'2018-11-06 23:05:00' AND region='gz' AND (cpuUsage=2.0 or cpuUsage=2.5)。minimum_should_match参数的意义在于设置cpuUsage=2.0 和 cpuUsage=2.5至少匹配的个数，系统默认minimum_should_match为0<br>

NOT条件JSON示例说明
    
	GET /ctsdb_test/_search
	{
  	"query": {
	    "bool": {
	      "filter": [
	                {
	          "range": {
	            "timestamp": {
	              "format": "yyyy-MM-dd HH:mm:ss",
	              "gte": "2017-11-06 23:00:00",
	              "lt": "2018-11-06 23:05:00"
	            }
	
	          }
	        },
	        {
	          "term": {
	            "region": "gz"
	          }
	        }
	      ],
	      "must_not": [
	       {
	          "term": {
	            "cpuUsage": "2.0"
	          }
	        }
	      ]
	    }
  	},
  	"docvalue_fields": [
    "cpuUsage",
    "timestamp"
  	]
  	}
> 注意：此查询条件类似于timestamp>=2017-11-06 23:00:00 AND timestamp<2018-11-06 23:05:00 AND region='gz' AND cpuUsage !=2.0

### 3.Terms ###
Terms关键字用于查询时匹配特定字段。<br>JSON示例说明

    GET /ctsdb_test/_search
	{
		"query": {
			"terms": {
				"region": ["sh", "bj"]
			}
		}
	}

## From / Size ##
通过设置From和Size关键字可对查询结果进行分页。From关键字定义了查询结果中第一条数据的偏移量，Size关键字配置返回结果的最大条数。From系统默认为0，Size系统默认为10，From与Size的总和系统默认不能超过65536。若想要更大的返回结果，请参考本文的scroll关键字查询。<br>
JSON示例说明

	GET /ctsdb_test/_search
	{
		"from": 0,
		"size": 5,
		"query": {
			"bool": {
				"filter": {
					"range": {
						"timestamp": {
							"gte": "01/01/2018",
							"lte": "03/01/2018",
							"format": "dd/MM/yyyy"
						}
					}
				},
				"must_not": {
					"terms": {
						"region": ["bj"]
					}
				}
			}
		}
	}

## Scroll ##
Scroll 可以理解为关系型数据库里的 cursor，因此 scroll 并不适合用来做实时搜索，而更适用于后台批处理任务。
可以把 scroll 分为初始化和遍历两个阶段，初始化时将所有符合搜索条件的搜索结果缓存起来，类似于快照，在遍历时，从这个快照里取数据。注意，在Scroll初始化后对metric的插入、删除、更新都不会影响遍历结果。<br>
初始化阶段可通过size关键字指定返回结果集的大小，size默认值为10，最大值为65536；初始化阶段可通过query关键字指定查询条件；初始化阶段可通过docvalue_fields关键字指定返回字段。初始化阶段和遍历阶段都返回_scroll_id字段，后续遍历可以通过指定前一次遍历返回的_scroll_id来进行新的遍历，直到返回结果为空；初始化和遍历两个阶段都可以通过指定scroll参数来设定遍历的上下文环境保留时间，过期后scroll_id将变得无效。时间格式如下表所示：<br>

| 格式        | 描述       |
|---------|---------|
|      d   |    days    |
|      h   |     hours        |
|      m   |    minutes   |
|      s   |     seconds        |
|      ms   |     milliseconds   |
|      micros   |     microseconds   |
|      nanos   |     nanoseconds   |
JSON示例说明<br>
scroll初始化：<br>
	
    POST /ctsdb_test/_search?scroll=1m
	{
	    "size":5,
	    "query": {
	        "filter" : {
	            "region" : "sh"
	        }
	    },
	    "docvalue_fields": [
	      	"cpuUsage",
		    "region",
		    "timestamp"
	  	  ]
	}
scroll初始化返回：<br>

    {
	  	"_scroll_id": "DnF1ZXJ5VGhlbkZldGNoAwAAAAAADrOFFm5YSEhnMjdnUWNPcndHS1k5Wjc3bHcAAAAAAAz_1RZiRkZTcGp4dFRXR18xMGtzSmhEUFJRAAAAAAAP5vQWOXFOR29lc0hROHFWMmFGTkVmSkxmZw==",
	  	"took": 10641,
	  	"timed_out": false,
	  	"_shards": {
	    "total": 3,
	    "successful": 3,
	    "skipped": 0,
	    "failed": 0
	  	},
	  	"hits": {
	    "total": 1592072666,
	    "max_score": 0.65708643,
	    "hits": [
	      {
	        "_index": "ctsdb_test@0_-1",
	        "_type": "doc",
	        "_id": "oyylNU0U65cZjByyt7sW_JmPPgAACY4Bh0",
	        "_score": 0.65708643,
	        "_routing": "354d14eb",
	        "fields": {
	          "region": [
	            "gz"
	          ],
	          "cpuUsage": [
	            "2.0"
	          ],
	          "timestamp": [
	            1509909300000
	          ]
	        }
	      },
	      {
	        "_index": "ctsdb_test@0_-1",
	        "_type": "doc",
	        "_id": "oyykFN0yd1d9NDPfzjRdrJ8whQAACYsBqc",
	        "_score": 0.65708643,
	        "_routing": "14dd3277",
	        "fields": {
	          "region": [
	            "gz"
	          ],
	          "cpuUsage": [
	            "1.8"
	          ],
	          "timestamp": [
	            1509908340000
	          ]
	        }
	      },
	      {
	        "_index": "ctsdb_test@0_-1",
	        "_type": "doc",
	        "_id": "oyylHLp9jl_3sF4N2rnh67h4SgAABHIBso",
	        "_score": 0.65708643,
	        "_routing": "1cba7d8e",
	        "fields": {
	          "region": [
	            "gz"
	          ],
	          "cpuUsage": [
	            "2.5"
	          ],
	          "timestamp": [
	            1509909720000
	          ]
	        }
	      },
	      {
	        "_index": "ctsdb_test@0_-1",
	        "_type": "doc",
	        "_id": "oyylH2JsOKnFHGUinQ7jM-ZwkgAAAvcBso",
	        "_score": 0.65708643,
	        "_routing": "1f626c38",
	        "fields": {
	          "region": [
	            "gz"
	          ],
	          "cpuUsage": [
	            "2.1"
	          ],
	          "timestamp": [
	            1509909720000
	          ]
	        }
	      },
	      {
	        "_index": "ctsdb_test@0_-1",
	        "_type": "doc",
	        "_id": "oyylHLp9jl_3sF4N2rnh67h4SgAABGsBso",
	        "_score": 0.65708643,
	        "_routing": "1cba7d8e",
	        "fields": {
	          "region": [
	            "gz"
	          ],
	          "cpuUsage": [
	            "2.0"
	          ],
	          "timestamp": [
	            1509909720000
	          ]
	        }
	      }
	    ]
	  	}
	}
scroll遍历：<br>

    POST  /_search/scroll 
	{
    "scroll" : "1m", 
    "scroll_id" : "DnF1ZXJ5VGhlbkZldGNoAwAAAAAADrOFFm5YSEhnMjdnUWNPcndHS1k5Wjc3bHcAAAAAAAz_1RZiRkZTcGp4dFRXR18xMGtzSmhEUFJRAAAAAAAP5vQWOXFOR29lc0hROHFWMmFGTkVmSkxmZw==" 
	}
> 注意：此请求中的scroll_id是scroll初始化返回的_scroll_id值。而下一次遍历则需要将scroll_id参数调整为上一次遍历返回的_scroll_id值，即每次请求中的scroll_id参数是上一次请求返回的_scroll_id值，直到返回结果为空，遍历结束。
## Sort ##
Sort关键字主要用于对查询结果进行排序。排序方式有asc和desc两种，CTSDB对于用户自定义字段的默认排序方式为asc。排序模式有min、max、sum、avg、median。其中sum、avg、median只适用于类型为array并存储数字的字段。<br>
JSON示例说明<br>

    GET /ctsdb_test/_search
	{
		"query": {
			"bool": {
				"must": {
					"range": {
						"timestamp": {
							"gte": "01/01/2018",
							"lte": "03/01/2018",
							"format": "MM/dd/yyyy"
						}
					}
				}
			}
		},
		"sort": [
	        {
				"cpuUsage": {
					"order": "asc",
					"mode": "min"
				}
			},
	        {
				"timestamp": {
					"order": "asc"
				}
			}, 
	        "diskUsage"
	    ]
	}
## docvalue_fields ##
docvalue_fields关键词指定需要返回的字段名称，需要以数组的形式指定。<br>
JSON示例说明<br>

    GET /ctsdb_test/_search
	{
		"query": {
			"terms": {
				"region": ["sh", "bj"]
			}
		},
		"docvalue_fields": ["timestamp", "cpuUsage"]
	}
## agg ##
agg关键字主要用于构造聚合查询。下面列举几种常用的聚合方式。
### 1.普通聚合 ###
普通聚合需要指定聚合名称、聚合方式（常用的聚合方式有min、max、avg、count等）和聚合所作用的字段。<br>
JSON示例说明<br>

    GET /ctsdb_test/_search
	{
		"query": {
			"terms": {
				"region": ["sh", "bj"]
			}
		},
		"aggs": {
			"myname": {
				"max": {
					"field": "cpuUsage"
				}
			}
		}
	}
### 2.Date Histogram聚合 ###
Date Histogram主要对日期做直方图聚合。<br>
JSON示例说明<br>

    GET /ctsdb_test/_search
	{
		"query": {
			"terms": {
				"region": ["sh", "bj"]
			}
		},
		"aggs": {
			"time_1m_agg": {
				"date_histogram": {
					"field": "timestamp",
					"interval": "1m"
				},
				"aggs": {
					"avg_of_cpu_usage": {
						"avg": {
							"field": "cpuUsage"
						}
					}
				}
			}
		}
	}
### 3.Percentiles聚合 ###
Percentiles聚合即百分位聚合。百分位可以任意指定，系统默认的百分位是1、5、25、50、75、95、99。<br>
JSON示例说明<br>

	GET /ctsdb_test/_search
    {
		"query": {
			"terms": {
				"region": ["sh", "bj"]
			}
		},
		"aggs": 
	    {
	        "myname": 
	        {
	            "percentiles":
	            {
	                "field": "cpuUsage",
	                "percents": [1,25,50,70,99]
	            }
	        }
	    }
	}
### 4.Cardinality聚合 ###
Cardinality聚合主要用于统计去重后的数量。注意，Cardinality 返回的结果是一个近似值。<br>
JSON示例说明<br>

	GET /ctsdb_test/_search
    {
		"query": {
			"terms": {
				"region": ["sh", "bj"]
			}
		},
		"aggs": 
	    {
	        "myname": 
	        {
	            "cardinality":
	            {
	                "field": "cpuUsage"
	            }
	        }
	    }
	}