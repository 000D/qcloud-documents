此篇文章主要介绍CTSDB中常用查询及关键字的使用，并给出简单JSON示例。所有示例使用的metric结构如下所示：<br>

    {
	    "ctsdb_test" : {
	      "tags" : {
	        "region" : "string"
	      },
	      "time" : {
	        "name" : "timestamp",
	        "format" : "epoch_millis"
	      },
	      "fields" : {
	        "cpuUsage" : "float",
	        "diskUsage" : "string",
	        "dcpuUsage" : "integer"
	      },
	      "options" : {
	        "expire_day" : 7,
	        "refresh_interval" : "10s",
	        "number_of_shards" : 5
	      }
	    }
	}

## 组合查询 ##
这里的组合查询即可以用于单查询也可用于复合查询。查询体中的query关键字通过Query DSL(Domain Specific Language)来定义查询条件。下文会先介绍如何构造过滤条件再介绍怎样组合过滤条件和如何处理返回结果集。
### 常用过滤条件 ###
#### 1.Range ####
Range即区间查询，Range查询支持的字段类型包括string、long、integer、short、double、float、date。Range查询可包含的参数如下表所示：

| 参数名称        | 描述       |
|---------|---------|
|      gte   |    大于或等于    |
|      gt   |     大于        |
|      lte   |    小于或等于   |
|      lt   |     小于        |
> 注意：当Range查询涉及时间类型时，可通过format参数来指定时间格式。具体时间格式请参考[新建 metric](https://cloud.tencent.com/document/product/652/13604)。<br>

时间范围查询的JSON示例：<br>

    GET /ctsdb_test/_search
	{
		"query": {
			"range": {
				"timestamp": {
					"gte": "01/01/2018",
					"lte": "03/01/2018",
					"format": "MM/dd/yyyy"
				  }
			  }
		  }
	 }
数字范围查询JSON示例：<br>

	GET /ctsdb_test/_search
	{
		"query": {
			"range": {
				"cpuUsage": {
					"gte": 1.0,
					"lte": 10.0
				}
			}
		}
	}    
#### 2.Terms ####
Terms关键字用于查询时匹配特定字段。<br>JSON示例说明

    GET /ctsdb_test/_search
	{
		"query": {
			"terms": {
				"region": ["sh", "bj"]
			}
		}
	}

### 过滤条件组合 ###
复合查询常使用Bool关键字来组合多个查询条件，常见的用于Bool查询的组合关键字有filter、must_not、should。为提高查询性能，请务必加上time字段的range查询，且time字段，不论查询时以何种方式写入，返回值统一为epoch_millis格式。query-bool-filter的组合形式可显著提升查询性能，请务必采用这种查询方式。
#### 1.AND条件JSON示例说明 ####

    GET /ctsdb_test/_search
	{
  	"query": {
	    "bool": {
	      "filter": [
	        {
	          "range": {
	            "timestamp": {
	              "format": "yyyy-MM-dd HH:mm:ss",
	              "gte": "2017-11-06 23:00:00",
	              "lt": "2018-03-06 23:05:00"
	            }
	
	          }
	        },
	        {
	          "terms": {
	            "region": ["sh"]
	          }
	        },
	        {
	          "terms": {
	            "cpuUsage": ["2.0"]
	          }
	        }
	      ]
	    }
	  },
  	 "docvalue_fields": [
	    "cpuUsage",
	    "timestamp"
  	  ]
	}
> 注意：此查询条件类似于timestamp>='2017-11-06 23:00:00' AND timestamp<'2018-03-06 23:05:00' AND region=sh AND cpuUsage=2.0。<br>

#### 2.OR条件JSON示例说明 ####

    GET /ctsdb_test/_search
	{
  	"query": {
	    "bool": {
	      "filter": [
	        {
	          "range": {
	            "timestamp": {
	              "format": "yyyy-MM-dd HH:mm:ss",
	              "gte": "2017-11-06 23:00:00",
	              "lt": "2018-11-06 23:05:00"
	            }
	          }
	        },
	        {
	          "term": {
	            "region": "gz"
	          }
	        }
	      ],
	      "should": [
	        {
	          "terms": {
	            "cpuUsage": ["2.0"]
	          }
	        },
	        {
	          "terms": {
	            "cpuUsage": ["2.5"]
	          }
	        }
	      ],
	      "minimum_should_match": 1
	    }
  	},
  	"docvalue_fields": [
	    "cpuUsage",
	    "timestamp"
  	]
	}
> 注意：此查询条件类似于timestamp>='2017-11-06 23:00:00' AND timestamp<'2018-11-06 23:05:00' AND region='gz' AND (cpuUsage=2.0 or cpuUsage=2.5)。minimum_should_match参数的意义在于设置cpuUsage=2.0 和 cpuUsage=2.5至少匹配的个数，系统默认minimum_should_match为0<br>

#### 3.NOT条件JSON示例说明 ####
    
	GET /ctsdb_test/_search
	{
  	"query": {
	    "bool": {
	      "filter": [
	                {
	          "range": {
	            "timestamp": {
	              "format": "yyyy-MM-dd HH:mm:ss",
	              "gte": "2017-11-06 23:00:00",
	              "lt": "2018-11-06 23:05:00"
	            }
	
	          }
	        },
	        {
	          "terms": {
	            "region": ["gz"]
	          }
	        }
	      ],
	      "must_not": [
	       {
	          "terms": {
	            "cpuUsage": ["2.0"]
	          }
	        }
	      ]
	    }
  	},
  	"docvalue_fields": [
	    "cpuUsage",
	    "timestamp"
  		]
  	}
> 注意：此查询条件类似于timestamp>=2017-11-06 23:00:00 AND timestamp<2018-11-06 23:05:00 AND region='gz' AND cpuUsage !=2.0

### 返回结果集处理 ###
#### 1.From / Size ####
通过设置From和Size关键字可对查询结果进行分页。From关键字定义了查询结果中第一条数据的偏移量，Size关键字配置返回结果的最大条数。From系统默认为0，Size系统默认为10，From与Size的总和系统默认不能超过65536。若想要更大的返回结果，请参考本文的scroll关键字查询。<br>
JSON示例说明

	GET /ctsdb_test/_search
	{
		"from": 0,
		"size": 5,
		"query": {
			"bool": {
				"filter": {
					"range": {
						"timestamp": {
							"gte": "01/01/2018",
							"lte": "03/01/2018",
							"format": "dd/MM/yyyy"
						}
					}
				},
				"must_not": {
					"terms": {
						"region": ["bj"]
					}
				}
			}
		}
	}

#### 2.Scroll ####
Scroll 可以理解为关系型数据库里的 cursor，因此 scroll 并不适合用来做实时搜索，而更适用于后台批处理任务。
可以把 scroll 分为初始化和遍历两个阶段，初始化时将所有符合搜索条件的搜索结果缓存起来，类似于快照，在遍历时，从这个快照里取数据。注意，在Scroll初始化后对metric的插入、删除、更新都不会影响遍历结果。<br>
初始化阶段可通过size关键字指定返回结果集的大小，size默认值为10，最大值为65536；初始化阶段可通过query关键字指定查询条件；初始化阶段可通过docvalue_fields关键字指定返回字段。初始化阶段和遍历阶段都返回_scroll_id字段，后续遍历可以通过指定前一次遍历返回的_scroll_id来进行新的遍历，直到返回结果为空；初始化和遍历两个阶段都可以通过指定scroll参数来设定遍历的上下文环境保留时间，过期后scroll_id将变得无效。时间格式如下表所示：<br>

| 格式        | 描述       |
|---------|---------|
|      d   |    days    |
|      h   |     hours        |
|      m   |    minutes   |
|      s   |     seconds        |
|      ms   |     milliseconds   |
|      micros   |     microseconds   |
|      nanos   |     nanoseconds   |
JSON示例说明<br>
scroll初始化：<br>
	
    POST /ctsdb_test/_search?scroll=1m
	{
	    "size":5,
	    "query": {
	        "filter" : {
	            "region" : "sh"
	        }
	    },
	    "docvalue_fields": [
	      	"cpuUsage",
		    "region",
		    "timestamp"
	  	  ]
	}
scroll初始化返回：<br>

    {
	  	"_scroll_id": "DnF1ZXJ5VGhlbkZldGNoAwAAAAAADrOFFm5YSEhnMjdnUWNPcndHS1k5Wjc3bHcAAAAAAAz_1RZiRkZTcGp4dFRXR18xMGtzSmhEUFJRAAAAAAAP5vQWOXFOR29lc0hROHFWMmFGTkVmSkxmZw==",
	  	"took": 10641,
	  	"timed_out": false,
	  	"_shards": {
	    "total": 3,
	    "successful": 3,
	    "skipped": 0,
	    "failed": 0
	  	},
	  	"hits": {
	    "total": 1592072666,
	    "max_score": 0.65708643,
	    "hits": [
	      {
	        "_index": "ctsdb_test@0_-1",
	        "_type": "doc",
	        "_id": "oyylNU0U65cZjByyt7sW_JmPPgAACY4Bh0",
	        "_score": 0.65708643,
	        "_routing": "354d14eb",
	        "fields": {
	          "region": [
	            "gz"
	          ],
	          "cpuUsage": [
	            "2.0"
	          ],
	          "timestamp": [
	            1509909300000
	          ]
	        }
	      },
	      {
	        "_index": "ctsdb_test@0_-1",
	        "_type": "doc",
	        "_id": "oyykFN0yd1d9NDPfzjRdrJ8whQAACYsBqc",
	        "_score": 0.65708643,
	        "_routing": "14dd3277",
	        "fields": {
	          "region": [
	            "gz"
	          ],
	          "cpuUsage": [
	            "1.8"
	          ],
	          "timestamp": [
	            1509908340000
	          ]
	        }
	      },
	      {
	        "_index": "ctsdb_test@0_-1",
	        "_type": "doc",
	        "_id": "oyylHLp9jl_3sF4N2rnh67h4SgAABHIBso",
	        "_score": 0.65708643,
	        "_routing": "1cba7d8e",
	        "fields": {
	          "region": [
	            "gz"
	          ],
	          "cpuUsage": [
	            "2.5"
	          ],
	          "timestamp": [
	            1509909720000
	          ]
	        }
	      },
	      {
	        "_index": "ctsdb_test@0_-1",
	        "_type": "doc",
	        "_id": "oyylH2JsOKnFHGUinQ7jM-ZwkgAAAvcBso",
	        "_score": 0.65708643,
	        "_routing": "1f626c38",
	        "fields": {
	          "region": [
	            "gz"
	          ],
	          "cpuUsage": [
	            "2.1"
	          ],
	          "timestamp": [
	            1509909720000
	          ]
	        }
	      },
	      {
	        "_index": "ctsdb_test@0_-1",
	        "_type": "doc",
	        "_id": "oyylHLp9jl_3sF4N2rnh67h4SgAABGsBso",
	        "_score": 0.65708643,
	        "_routing": "1cba7d8e",
	        "fields": {
	          "region": [
	            "gz"
	          ],
	          "cpuUsage": [
	            "2.0"
	          ],
	          "timestamp": [
	            1509909720000
	          ]
	        }
	      }
	    ]
	  	}
	}
scroll遍历：<br>

    POST  /_search/scroll 
	{
    "scroll" : "1m", 
    "scroll_id" : "DnF1ZXJ5VGhlbkZldGNoAwAAAAAADrOFFm5YSEhnMjdnUWNPcndHS1k5Wjc3bHcAAAAAAAz_1RZiRkZTcGp4dFRXR18xMGtzSmhEUFJRAAAAAAAP5vQWOXFOR29lc0hROHFWMmFGTkVmSkxmZw==" 
	}
> 注意：此请求中的scroll_id是scroll初始化返回的_scroll_id值。而下一次遍历则需要将scroll_id参数调整为上一次遍历返回的_scroll_id值，即每次请求中的scroll_id参数是上一次请求返回的_scroll_id值，直到返回结果为空，遍历结束。<br>


#### 3.Sort ####
Sort关键字主要用于对查询结果进行排序。排序方式有asc和desc两种，CTSDB对于用户自定义字段的默认排序方式为asc。排序模式有min、max、sum、avg、median。其中sum、avg、median只适用于类型为array并存储数字的字段。<br>
JSON示例说明<br>

    GET /ctsdb_test/_search
	{
		"query": {
			"bool": {
				"must": {
					"range": {
						"timestamp": {
							"gte": "01/01/2018",
							"lte": "03/01/2018",
							"format": "MM/dd/yyyy"
						}
					}
				}
			}
		},
		"sort": [
	        {
				"cpuUsage": {
					"order": "asc",
					"mode": "min"
				}
			},
	        {
				"timestamp": {
					"order": "asc"
				}
			}, 
	        "diskUsage"
	    ]
	}
#### 4.docvalue_fields ####
docvalue_fields关键词指定需要返回的字段名称，需要以数组的形式指定。<br>
JSON示例说明<br>

    GET /ctsdb_test/_search
	{
		"query": {
			"terms": {
				"region": ["sh", "bj"]
			}
		},
		"docvalue_fields": ["timestamp", "cpuUsage"]
	}

## 聚合查询 ##
agg关键字主要用于构造聚合查询。用户可到返回的aggregations字段取聚合结果。下面列举几种常用的聚合方式。
### 1.普通聚合 ###
普通聚合需要指定聚合名称、聚合方式（常用的聚合方式有min、max、avg、count、sum等）和聚合所作用的字段。<br>
JSON示例说明<br>

    GET /ctsdb_test/_search
	{
		"query": {
			"terms": {
				"region": ["sh", "bj"]
			}
		},
		"aggs": {
			"myname": {
				"max": {
					"field": "cpuUsage"
				}
			}
		}
	}
> 注意：上例中对字段cpuUsage做max聚合（用户也可指定min、avg等），返回结果取别名myname（用户可任意指定该名称）。<br>

### 2.Date Histogram聚合 ###
Date Histogram主要对日期做直方图聚合。<br>
JSON示例说明<br>

    GET /ctsdb_test/_search
	{
		"query": {
			"terms": {
				"region": ["sh", "bj"]
			}
		},
		"aggs": {
			"time_1h_agg": {
				"date_histogram": {
					"field": "timestamp",
					"interval": "1h"
				},
				"aggs": {
					"avgCpuUsage": {
						"avg": {
							"field": "cpuUsage"
						}
					}
				}
			}
		}
	}
返回结果<br>

    {
	  "took": 5,
	  "timed_out": false,
	  "_shards": {
	    "total": 20,
	    "successful": 20,
	    "skipped": 0,
	    "failed": 0
	  },
	  "hits": {
	    "total": 6,
	    "max_score": 0.074107975,
	    "hits": [
	      {
	        "_index": "ctsdb_test@1520092800000_3",
	        "_type": "doc",
	        "_id": "AWH2QtGR5xcjRaw2ETf-",
	        "_score": 0.074107975,
	        "_routing": "sh"
	      },
	      {
	        "_index": "ctsdb_test@1520092800000_3",
	        "_type": "doc",
	        "_id": "AWH2QtGR5xcjRaw2ETf_",
	        "_score": 0.074107975,
	        "_routing": "sh"
	      },
	      {
	        "_index": "ctsdb_test@1520092800000_3",
	        "_type": "doc",
	        "_id": "AWH2Q5Xr5xcjRaw2ETgA",
	        "_score": 0.074107975,
	        "_routing": "sh"
	      },
	      {
	        "_index": "ctsdb_test@1520092800000_3",
	        "_type": "doc",
	        "_id": "AWH2Q5Xr5xcjRaw2ETgB",
	        "_score": 0.074107975,
	        "_routing": "sh"
	      },
	      {
	        "_index": "ctsdb_test@1520092800000_3",
	        "_type": "doc",
	        "_id": "AWH2RGfF5xcjRaw2ETgC",
	        "_score": 0.074107975,
	        "_routing": "sh"
	      },
	      {
	        "_index": "ctsdb_test@1520092800000_3",
	        "_type": "doc",
	        "_id": "AWH2RGfF5xcjRaw2ETgD",
	        "_score": 0.074107975,
	        "_routing": "sh"
	      }
	    ]
	  },
	  "aggregations": {
	    "time_1h_agg": {
	      "buckets": [
	        {
	          "key_as_string": "1520222400",
	          "key": 1520222400000,
	          "doc_count": 1,
	          "avgCpuUsage": {
	            "value": 2.5
	          }
	        },
	        {
	          "key_as_string": "1520226000",
	          "key": 1520226000000,
	          "doc_count": 0,
	          "avgCpuUsage": {
	            "value": null
	          }
	        },
	        {
	          "key_as_string": "1520229600",
	          "key": 1520229600000,
	          "doc_count": 0,
	          "avgCpuUsage": {
	            "value": null
	          }
	        },
	        {
	          "key_as_string": "1520233200",
	          "key": 1520233200000,
	          "doc_count": 0,
	          "avgCpuUsage": {
	            "value": null
	          }
	        },
	        {
	          "key_as_string": "1520236800",
	          "key": 1520236800000,
	          "doc_count": 0,
	          "avgCpuUsage": {
	            "value": null
	          }
	        },
	        {
	          "key_as_string": "1520240400",
	          "key": 1520240400000,
	          "doc_count": 0,
	          "avgCpuUsage": {
	            "value": null
	          }
	        },
	        {
	          "key_as_string": "1520244000",
	          "key": 1520244000000,
	          "doc_count": 0,
	          "avgCpuUsage": {
	            "value": null
	          }
	        },
	        {
	          "key_as_string": "1520247600",
	          "key": 1520247600000,
	          "doc_count": 1,
	          "avgCpuUsage": {
	            "value": 2
	          }
	        },
	        {
	          "key_as_string": "1520251200",
	          "key": 1520251200000,
	          "doc_count": 4,
	          "avgCpuUsage": {
	            "value": 2.25
	          }
	        }
	      ]
	    }
	  }
	}

> 注意：上例是对字段cpuUsage进行粒度为1小时的date_histogram聚合。返回结果中总的聚合名称为time_1h_agg（用户可任意指定该名称），每个时间分段内的聚合名称为avgCpuUsage（用户可任意指定该名称）。interval字段可选的时间粒度有year、quarter、 month、week、day、hour、minute、second，用户也可将时间粒度用时间单位来表示，例如1y代表1year,1h代表1hour。系统不支持小数粒度的时间单位，例如1.5h您需要转换为90m。<br>

### 3.Percentiles聚合 ###
Percentiles聚合即百分位聚合。百分位可以任意指定，系统默认的百分位是1、5、25、50、75、95、99。<br>
JSON示例说明<br>

	GET /ctsdb_test/_search
    {
		"query": {
			"terms": {
				"region": ["sh", "bj"]
			}
		},
		"aggs": 
	    {
	        "myname": 
	        {
	            "percentiles":
	            {
	                "field": "cpuUsage",
	                "percents": [1,25,50,70,99]
	            }
	        }
	    }
	}
返回结果<br>

    {
	  "took": 18,
	  "timed_out": false,
	  "_shards": {
	    "total": 20,
	    "successful": 20,
	    "skipped": 0,
	    "failed": 0
	  },
	  "hits": {
	    "total": 6,
	    "max_score": 0.074107975,
	    "hits": [
	      {
	        "_index": "ctsdb_test@1520092800000_3",
	        "_type": "doc",
	        "_id": "AWH2QtGR5xcjRaw2ETf-",
	        "_score": 0.074107975,
	        "_routing": "sh"
	      },
	      {
	        "_index": "ctsdb_test@1520092800000_3",
	        "_type": "doc",
	        "_id": "AWH2QtGR5xcjRaw2ETf_",
	        "_score": 0.074107975,
	        "_routing": "sh"
	      },
	      {
	        "_index": "ctsdb_test@1520092800000_3",
	        "_type": "doc",
	        "_id": "AWH2Q5Xr5xcjRaw2ETgA",
	        "_score": 0.074107975,
	        "_routing": "sh"
	      },
	      {
	        "_index": "ctsdb_test@1520092800000_3",
	        "_type": "doc",
	        "_id": "AWH2Q5Xr5xcjRaw2ETgB",
	        "_score": 0.074107975,
	        "_routing": "sh"
	      },
	      {
	        "_index": "ctsdb_test@1520092800000_3",
	        "_type": "doc",
	        "_id": "AWH2RGfF5xcjRaw2ETgC",
	        "_score": 0.074107975,
	        "_routing": "sh"
	      },
	      {
	        "_index": "ctsdb_test@1520092800000_3",
	        "_type": "doc",
	        "_id": "AWH2RGfF5xcjRaw2ETgD",
	        "_score": 0.074107975,
	        "_routing": "sh"
	      }
	    ]
	  },
	  "aggregations": {
	    "myname": {
	      "values": {
	        "1.0": 2,
	        "25.0": 2,
	        "50.0": 2.25,
	        "70.0": 2.5,
	        "99.0": 2.5
	      }
	    }
	  }
	}
> 注意：上例中是对字段cpuUsage做percentiles聚合，选取的百分位为1,25,50,70,99。聚合返回结果的别名是myname（用户可任意指定该名称）。<br>

### 4.Cardinality聚合 ###
Cardinality聚合主要用于统计去重后的数量。注意，Cardinality 返回的结果是一个近似值。<br>
JSON示例说明<br>

	GET /ctsdb_test/_search
    {
		"query": {
			"terms": {
				"region": ["sh", "bj"]
			}
		},
		"aggs": 
	    {
	        "myname": 
	        {
	            "cardinality":
	            {
	                "field": "cpuUsage"
	            }
	        }
	    }
	}
返回结果<br>

    {
	  "took": 15,
	  "timed_out": false,
	  "_shards": {
	    "total": 20,
	    "successful": 20,
	    "skipped": 0,
	    "failed": 0
	  },
	  "hits": {
	    "total": 6,
	    "max_score": 0.074107975,
	    "hits": [
	      {
	        "_index": "ctsdb_test@1520092800000_3",
	        "_type": "doc",
	        "_id": "AWH2QtGR5xcjRaw2ETf-",
	        "_score": 0.074107975,
	        "_routing": "sh"
	      },
	      {
	        "_index": "ctsdb_test@1520092800000_3",
	        "_type": "doc",
	        "_id": "AWH2QtGR5xcjRaw2ETf_",
	        "_score": 0.074107975,
	        "_routing": "sh"
	      },
	      {
	        "_index": "ctsdb_test@1520092800000_3",
	        "_type": "doc",
	        "_id": "AWH2Q5Xr5xcjRaw2ETgA",
	        "_score": 0.074107975,
	        "_routing": "sh"
	      },
	      {
	        "_index": "ctsdb_test@1520092800000_3",
	        "_type": "doc",
	        "_id": "AWH2Q5Xr5xcjRaw2ETgB",
	        "_score": 0.074107975,
	        "_routing": "sh"
	      },
	      {
	        "_index": "ctsdb_test@1520092800000_3",
	        "_type": "doc",
	        "_id": "AWH2RGfF5xcjRaw2ETgC",
	        "_score": 0.074107975,
	        "_routing": "sh"
	      },
	      {
	        "_index": "ctsdb_test@1520092800000_3",
	        "_type": "doc",
	        "_id": "AWH2RGfF5xcjRaw2ETgD",
	        "_score": 0.074107975,
	        "_routing": "sh"
	      }
	    ]
	  },
	  "aggregations": {
	    "myname": {
	      "value": 2
	    }
	  }
	}
> 注意：上例的聚合是对字段cpuUsage做cardinality聚合，返回的聚合结果取别名myname（用户可任意指定该名称）