## 管理已启用多版本的存储桶中的对象
启用存储桶多版本前，已存储在存储桶中的对象，其版本 ID 为 null。启用多版本后，不会改变存储桶中的现有对象本身，只会改变对象存储对现有对象的处理方式（如请求方式）。而对于新添加的对象，存储桶会开始存放对象版本。以下将介绍在已启用多版本的存储桶中如何管理对象：

>**注意：**用户在未启用多版本和启用多版本的存储桶中添加对象的方式都是相同的，但其版本 ID 不同。通过第二种方式，对象存储会为对象分配特定版本 ID，而前一种方式添加的对象，其版本 ID 始终为 null。

### 在已启用多版本的存储桶中添加对象

对存储桶启用多版本后，当用户执行 PUT、POST 或 COPY 操作时，对象存储 COS 会为存放到该存储桶中的对象自动添加唯一的版本 ID。
如下图所示，在启用了多版本的存储桶中添加对象时，对象存储为该对象添加唯一的版本 ID。

![](https://main.qcloudimg.com/raw/b51243cc5ea64e84635e94236f2bd09c.png)

### 列出多版本对象

此部分提供从启用多版本的存储桶列出对象版本的示例。对象存储 在与存储桶关联的 versions 子资源中存储对象版本信息。
对象存储 COS 按照存储顺序返回对象版本，最先返回最近存储的版本。

### 检索特定对象的所有版本

您可以通过以下过程，使用 versions 子资源和 prefix 请求参数检索某对象的所有版本。有关 prefix 的更多信息，请参阅 GET Bucket。
检索键的所有版本，请求语法如下：
```
GET /?versions&prefix=objectName HTTP/1.1
```

### 检索数据元版本

用户使用 GET 请求时无指定版本 ID，将检索对象的当前版本。如下图所示，GET 请求将返回 123.txt 对象的当前版本（最近版本）。

![](https://main.qcloudimg.com/raw/de38f23343cc247a792d8114474225c2.png)

如用户使用 GET 请求时指定其版本 ID，将检索指定版本 ID 的对象。如下图所示，GET versionId 请求检索指定版本（可以是当前版本）的对象。

![](https://main.qcloudimg.com/raw/3810d1610265ebb4a9f4c326b1b8dc10.png)


#### 检索对象版本的元数据
如果您只需检索对象的元数据（而不是其内容），您可以使用 HEAD 操作。默认情况下，您将获得最新版本的元数据。如要检索指定对象版本的元数据，则发送请求时需要指定其版本 ID。
检索指定版本的对象的元数据步骤如下：
- 将 versionId 配置为被检索对象元数据的版本 ID。
- 发送 HEAD 操作 versionId 请求。

### 删除数据
您可以根据需要，随时删除不必要的对象版本。用户在已启用多版本状态下，使用 DELETE 请求有以下两个场景：

1. 用户未指定版本 ID，执行一般 DELETE 操作。

此操作场景类似于将被删除对象放到了“回收站”，但没有完全移除对象，后续用户如有需要仍然可以恢复数据。
如下图所示，用户在 DELETE 操作时不指定版本 ID，实际上不会删除 Key=123.txt 的对象，而是插入一个新的删除标记，并添加新的版本 ID。

![](https://main.qcloudimg.com/raw/d84083ebc73053ca29fd5503d79ff750.png)

>**注意：**对象存储 COS 将在存储桶中为被删除对象插入一个拥有新版本 ID 的删除标记，该删除标记将成为被删除对象的当前版本。当您尝试对该删除标记的对象执行 GET 操作时，对象存储会认为该对象不存在，并返回 404 错误。

2.用户指定版本 ID，执行操作 DELETE Object versionId，此场景可以永久删除多版本的对象。

![](https://main.qcloudimg.com/raw/3866ea99b80cfcee5daa8375d61fdd06.png)

#### 删除标记
删除标记用于多版本的对象，删除标记在对象存储 COS 中可认为是“对象已被删除”的标记。删除标记与对象同样拥有对象键（Key）和版本 ID。区别在于以下几点：
- 删除标记的内容为空。
- 删除标记不存在 ACL 值。
- 删除标记执行 GET 请求会返回 404 错误。
>响应返回如下：
>404 (Object not found) 错误
>响应标头 x-cos-delete-marker: true
- 删除标记只支持 DELETE 操作（需要根账号下发出请求）

#### 删除“删除标记”
用户如需删除“删除标记”，则可以在 DELETE Object versionId 请求中指定它的版本 ID，实现永久删除“删除标记”。如果您未指定删除标记的版本 ID，对删除标记发出 DELETE 请求，对象存储 COS 将不会删除该删除标记，而是再插入一个新的删除标记。
如下图所示，对删除标记执行一般 DELETE 请求，不会删除任何内容，而在存储桶里新增了一个新的删除标记。

![](https://main.qcloudimg.com/raw/d56c346b4c42ebf7b42b30e4c1969af0.png)

在已启用多版本的存储桶中，新增的删除标记将具有唯一的版本 ID。因此，在一个存储桶中，同一个对象可能有多个删除标记。要永久删除“删除标记”，必须在 DELETE Object versionId 请求中包含其版本 ID。
如下图所示，执行 DELETE Object versionId 请求永久删除“删除标记”。

![](https://main.qcloudimg.com/raw/f4a7c23b94a671151d69d443b8d4568b.png)

>**注意：**只有根账号可以永久删除“删除标记”。

永久删除“删除标记”的步骤：
1. 将 versionId 设置为要删除的删除标记的版本 ID。
2. 发送 DELETE Object versionId 请求。

### 还原早期版本
多版本的其中一个价值主张是能够检索对象的早期版本，有两种方法可执行该操作：
1. 将对象的早期版本复制到同一存储桶中
复制的对象将成为该对象的当前版本，且所有对象版本都保留。
2. 永久删除对象的当前版本
当您删除当前对象版本时，实际上会将后一个版本转换为该对象的当前版本。
