# 小直播集成中遇到的常见问题
## 1. 业务后台配置参数错误有什么表现？
### 1.1 appid 或者 bizid 
主播端推流一直失败，表现如下。原因生成的推流地址无效，有效的推流地址[详见直播码](https://www.qcloud.com/document/product/454/7915)

![](//mc.qcloudimg.com/static/img/4f408cd345052ab51cdbce7c1dfa196f/image.png)

### 1.2 推流防盗链key 
直播端推流一直失败，表现如下。原因是错误的推流防盗链key，生成了错误的txSecret，导致服务器对txSecret校验失败并拒绝推流请求。

![](//mc.qcloudimg.com/static/img/6fc9c4413d24cae8381a2ed1e317e7a5/image.png)

### 1.3  API鉴权key 
推流播放均正常，但是没有生成回看列表。原因分析，是由于API鉴权key配置错误，导致录制系统回调业务后台鉴权失败，没有生成回看记录到数据库中。

### 1.4  COS APPID 
COS 上传请求所用到的签名是由业务后台下发的。由于签名错误，导致上传请求失败，会导致头像和封面的上传失败。通过终端的日志关键字 “**ERROR_PROXY_APPID_USERID_NOTMATCH**”可以确认。

![](//mc.qcloudimg.com/static/img/378e8a055f12f6aa77b2958ad1c3f149/image.png)

### 1.5  COS Bucket名称 
 COS 上传请求所用到的签名是由业务后台下发的。由于签名错误，导致上传请求失败，会导致头像和封面的上传失败。通过终端的日志关键字 “**ERROR_PROXY_SIGN_BUCKET_NOTMATCH**”可以确认。
 
 ![](//mc.qcloudimg.com/static/img/92e096149bef3408c9713df93ab321ac/image.png)
 
### 1.6 COS SecretId 
 COS 上传请求所用到的签名是由业务后台下发的。由于签名错误，导致上传请求失败，会导致头像和封面的上传失败。通过终端的日志关键字 “**PROXY_AUTH_SECRETID_NOEXIST**”可以确认。
 
 ![](//mc.qcloudimg.com/static/img/3fbfd0180fc165784c1ce30e513be5c7/image.png)
 
### 1.7  COS SecretKey 
 COS 上传请求所用到的签名是由业务后台下发的。由于签名错误，导致上传请求失败，会导致头像和封面的上传失败。通过终端的日志关键字 “**ERROR_PROXY_AUTH_FAILED**”可以确认。
 
 ![](//mc.qcloudimg.com/static/img/f1ac76d8ea4b70b883c4a45d74ee888d/image.png)


## 2. 终端（ios为例）参数错误有什么表现？
### 2.1 kTCIMSDKAppId 或者 kTCIMSDKAccountType
IM SDK相关的两个参数配置错误，会导致登录失败。

![](//mc.qcloudimg.com/static/img/7f6ed763233bd81d1e71079c39ba47d6/image.png)

### 2.2 kTCCOSAppId 或者 kTCCOSBucket
COS相关的两个参数配置错误，会导致头像或封面上传失败。log表现如下：

![](//mc.qcloudimg.com/static/img/4192cf72b525664098fb69cd2e02ba7c/image.png)

### 2.3 kTCCOSRegion 
COS 4.0 新增的参数，配置错误，会导致头像或封面上传失败。log表现如下：

![](//mc.qcloudimg.com/static/img/b023701ec5c2fe69ab35816b422afe16/image.png)

### 2.4 kHttpServerAddr 
参数配置错误，如果host部分填错直接导致无法访问到正确的业务服务器，拉取直播列表功能会失败。如果没有采用https协议请求。IOS可能会遇到ATS问题。如图表现。

![](//mc.qcloudimg.com/static/img/9ddd969beb4c972e9b55f3d15b5a3f0b/image.png)

## 3. 为何拉取回看列表失败？
回看列表是存放在数据 tape_data表中的。遇到拉取失败可以从以下几个方面一一排查。

![](//mc.qcloudimg.com/static/img/f28487d33a502e571737bc9c687647ac/image.png)

### 3.1 回调后写数据库是否正常
 一般您不改动我们的的后台源码，一般不会有问题。如果您有改动到createDB脚本，那么就有必要排查一下这里。log是一个很好的排查问题的工具。后台开启调试log的方法，是在 live_demo_service/目录下创建 log 目录，即可。关注 mysql_XXXX.log。
 
### 3.2 API鉴权Key是否正确
 确保OutDefine.php 中 CALL_BACK_KEY的值和控制台API鉴权Key一致。
 
### 3.3 回调URL设置是否正确
 检查腾讯云官网-管理中心-直播-接入管理-直播码接入-接入配置中回调URL是否正确填写。如果错误的话，直播结束后，业务后台收不到腾讯云服务器的通知回调，也就没有生成回看纪录。
 
![](//mc.qcloudimg.com/static/img/61187098d48fecd3f4554d45a8503aa6/image.png)

## 4. 为何拉取播放列表失败？
列表主要存放在数据库的live_data（直播列表）和tape_data（回看列表）两个表中。
### 4.1 server内部错误，数据库访问失败
Android app登录之后提示拉取列表失败，logcat中可以看到信息“**HTTP Req error, error code:500**”，iphone app登录后提示**internal server error**。后台log目录下的mysql_errorxxxxxxxx.log打开可以看到信息**mysqli_connect failed, error:Access denied for user 'live_user'@'localhost' to database 'live'**]
由于数据库访问失败导致接口失败。确认方法在live_demo_service/conf 目录下打开 cdn.route.ini 文件，确保DB 参数和您创建数据库时指定的是一致的。PHP通过cdn.route.ini指定的参数来访问本地数据库的。具体对应关系如图：

![](//mc.qcloudimg.com/static/img/1a5a63e3ac06eb9eab85a0b0ed1b8879/image.png)

### 4.2 终端 kHttpServerAddr / SVR_POST_URL 配置错误
具体可以参看参数意义说明。

## 5. 为何拉取头像或封面失败？
上传头像或者封面成功，但是下载失败，终端的头像封面一直是默认的。是因为COS是一个存储系统，需要通过内容分发服务CDN，来加速资源的下载，请确认是否是没有打开COS配置中的加速域名选项导致。

![](//mc.qcloudimg.com/static/img/a2fd6cf344295b547d8d7c417142af45/image.png)

## 6. 为何COS参数设置没有问题但上传还是失败？
COS 2016年11月份进行了一次版本升级，增加了区域参数。新的系统和旧系统是完全独立的两套，互相不兼容（需要配合对应版本的cos sdk才能使用）。cos当前版本是v4。老版本cos可以**提交工单**申请切成cosv4。2016年12月30日开始小直播源码包也搭载了cos sdk v4版本。bucket可以理解为是cos 中的一个虚拟硬盘。老版本的cos控制台创建的bucket，新版本cos sdk v4，上传是会失败的。解决办法是在cos v4平台下创建一个新的bucket，将参数设置为新的bucket即可。
