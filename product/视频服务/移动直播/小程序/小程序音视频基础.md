## 内部原理
所有音视频相关的产品，都可以理解为是由音视频上行和音视频下行组成的，这里就对一些基础知识进行一些解释：
- **音视频上行**
也叫推送（push），即把本地的音视频数据传输到云端，这包括驱动本地摄像头和麦克风进行画面和声音的采集，再把采集到的裸数据进行必要的预处理（比如去噪、美颜、缩放、裁剪等），之后要对处理后的数据进行编码压缩，最终交给网络模块用 TCP 或者 UDP 协议发送出去。

- **音视频下行**
也叫播放（play），即从云端拉取编码压缩后的音视频数据，之后进行必要的抖动缓冲（jitterbuffer），抖动缓冲就像一个小的蓄水池，其存在的目的是缓冲网速的波动，防止网落的不稳定诱发播放的卡顿。经过抖动缓冲的平稳的数据会送给解码器进行解码，之后再将解码后的数据进行渲染和播放。

- **点对点连接**
传统的双向音视频通话中会强依赖点对点直连技术，即通话的双方在网络上是通过 UDP 打洞技术进行直连的，中间不借助服务器进行中转。这是由于早年带宽成本极为昂贵，没有公司愿意无偿支付服务器中转的带宽成本。但这种直连方案的通话质量是无法保证的，不仅仅连通率很低，而且由于没有 server 中转，出于商用考虑的录制和存储（比如客服系统、金融开户、电子政务等场景都有记录和反查的需要）也无从谈起。

- **以云为中心**
现在的音视频直播和通话技术都是以云为中心的，即采用服务器中转的模式为主。一方面，由于服务器集群的边缘节点可以越做越多（以腾讯云为例，拥有上万台服务器遍布大中小各个机房），最终用户到服务器这“最后一公里”的质量得到了很好的保障，链路质量和稳定性远远好于点对点直连。另一方面，以云为中心，也可以实现录制、存储、转码等商用附加服务。

- **所需终端技术**
【回音消除】：在双向通话和多人会议场景中，用户自己手机的麦克风会把喇叭里播放的声音再次记录下来，如果不将其抹除掉，这些声音会被反送给另一端的用户，从而形成回声。
【噪声抑制】：将用户所处环境里的背景噪音去除掉，以便让用户自身的人声更加清晰和易于分辨。
【自动增益】：在多人会议场景中较为有用，因为不是每个人都离麦克风同样的距离，所以声学处理模块需要对距离较远的发言者的声音进行自动的放大。
【延迟修正】：不论是直播还是视频通话，延迟都不能随着使用时间的增长而越积越大，延迟修正的目标是要在用户不易察觉的情况下将网络波动所累积的延迟逐渐抵消回去。
【丢包恢复】：再好的网络也难免会有丢包的情况，丢包恢复的作用就是防止数据包的遗失对传输质量的影响。
【流量控制】：网络不可能一直都很完美，尤其是中国大陆地区的上行网速，不仅仅带宽有限而且经常会被这一区域的其他网民影响到。流量控制的作用就是预测当前用户的上行带宽，并对编码器进行控制，以确保最终要送出的数据不会超过当前网络的传输能力的极限。

- **UDP & TCP**
对于直播场景，TCP 协议已经足够好用，直播中常见的 RTMP 协议、FLV 播放协议都是基于 TCP 协议实现的。但对于实时音视频通话场景，UDP 协议则更加适合，因为 UDP 协议的发包控制更加灵活，可以在一些极端的场景下通过主动地丢包来避免延迟的堆积。

- **小程序中的音视频**
小程序中的音视频模块是微信团队同腾讯视频云团队联合打造的，通过内置视频云 SDK 的方式，最新版本的小程序中支持 live-pusher 和 live-player 两个标签，用于实现音视频上行和下行能力，并且支持高并发直播（Live）和实时音视频通话（RTC）两种模式。

![](//mc.qcloudimg.com/static/img/6a14ff3b24b8b3248eda2c7f987b5dfb/image.jpg)

## 两种模式
- **在线直播模式（Live）**
主要用于直播类场景，比如赛事直播、在线教育、远程培训等等。该模式下，小程序会更加注重清晰度和观看的流畅性，不会过分强调低延迟，也不会为了延迟牺牲画质和流畅性（对于 720p 以下的直播可以做到 2 - 3 秒的延迟，720p 以及 1080p 的直播可以做到 3 - 5 秒的延迟）。该模式下的延迟越高，卡顿率越低。

- **实时通话模式（RTC）**
主要用于双向或者多人的视频通话场景，比如金融开会、在线客服、车险定损、培训会议 等等。该模式下，小程序会更加注重降低点到点的时延，也会优先保证声音的质量，在必要的时候会对画面清晰度和画面的流畅性进行一定的缩水。该模式下的点到点时延通常可以做到500ms左右，网络质量较差的情况下也可以基本保证 1s 以内的延迟。


## 应用场景
基于简单的音视频上行和下行，理论上可以构造出无限多种音视频应用，下面我们具几个典型的应用场景：

- **企业培训**
![](//mc.qcloudimg.com/static/img/2227bae17d0ec7b20c559dce95970e58/image.jpg)

- **在线电玩**
![](//mc.qcloudimg.com/static/img/6439160b7f1d0c0fc170e814d5b182c3/image.jpg)

- **车险定损**
![](//mc.qcloudimg.com/static/img/b521038719919583a3ca58a27bd36c07/image.jpg)

- **多人会议**
![](//mc.qcloudimg.com/static/img/272878f44773f51d4b1d3d9688aed0d3/image.jpg)



