# 双人视频

## 功能体验

您可以从腾讯云官网 [直播SDK](https://cloud.tencent.com/document/product/454/7873)中获取目前最新ActiveX插件SDK有。

下载完的SDK解压后有以下几个部分：

 ![sdk_folder_info](res\sdk_folder_info.png)

在demo/doublevideo/RtcRoomDemo.htm用于双人视频的演示，通过pusher标签player标签所构建的双人视频通话功能

![double1](res\double1.png)



## 双人视频交互原理

 ![double2](res\double2.png)



解读：通讯的双方 A 和 B 各自创建一个pusher标签和player标签，并各自用一个URL推流，然后交换双方的推流URL给对方，对方用交互来的URL进行拉流播放，既可以实现双人视频。

### 流程解读

![double3](res\double3.png)

- step1A 跟业务服务器沟通，获取 push­url­A 和低延时的 play­url­A，服务器分配 URL
  的方法参考 [DOC]( https://cloud.tencent.com/document/product/454/7915 "腾讯云-推拉流地址Doc") ）


- step2：A 创建< object id="pusherA">  标签，指定 url 为 step1 中获得的 push­urlA。并设置事件回调函数

  ```
  pusherA.setPusherEventCallBack(PusherEventListener, 1);
  var PusherEventListener = function (paramJson) {
      var obj = JSON.parse(paramJson);
      if (parseInt(obj.eventId) == PusherCallBackEvent.TXE_STATUS_UPLOAD_EVENT && parseInt(obj.objectId) == 1) {
          ....
      }
  };
  ```

- step3：A 这边需要一些时间启动推流，推流开始以后， 会通过 PusherEventListener
  的 PUSH_EVT_PUSH_BEGIN（1002）事件通知给 A， 此时 A 可以向 B 发起通话请求，请
  求中可以携带 play­url­A。


- step4：B 需要等待 UI 界面上的确认，如果 B 确认接通，接下来要做的就是创建一个 < object id="playerB">  ，并指定 src 为 play­url­A。


- step5：B 此时还要跟业务服务器沟通，获取 push­url­B 和低延时的 play­url­B，并创建一
  个 < object id="pusherB">  标签，指定 url 为 push­url­B，并设置事件回调函数

  ```
  pusherB.setPusherEventCallBack(PusherEventListener, 1);
  var PusherEventListener = function (paramJson) {
      var obj = JSON.parse(paramJson);
      if (parseInt(obj.eventId) == PusherCallBackEvent.TXE_STATUS_UPLOAD_EVENT && parseInt(obj.objectId) == 1) {
          ....
      }
  };
  ```

- step6：B 此时需要一些时间启动推流，推流开始以后， 会通过 PusherEventListener
  的 PUSH_EVT_PUSH_BEGIN（1002）事件通知给 B，之后 B 可以向 A 响应通话请求，请
  求中可以携带 play­url­B。


- step7: A 此时要做的就是创建一个  object id="playerA">  ，并指定 src 为 play­url­B。

  ​

## 真是场景

以上七个步骤虽然不难理解，但对于真正想要照此实现的您而言，显然也是个不小的工作量，而在现实的商用场景中，我们需要面对的业务逻辑远比简单的把 A 和 B 连接起来要复杂。



* **房间管理**

以金融开户和保险定损为例，如果 A 端使用的是小程序，那么真正的 B 端一般情况下会是企业的客服人员（通常都是一个人），所以这里就牵扯到要给用户分配客服的逻辑，同时，如果目前所有的客服都是忙碌的，那就需要有排队等待的逻辑。

常用的解决方案是 客服MM 在上班后即创建好一个属于自己的“房间”，这个房间有三种状态，BUSY(忙碌)、IDLE(空间) 以及 CLOSE(关闭)。处于 BUSY 状态的房间表示对应的客服正在跟用户进行沟通， IDLE 表示可以分配给新进来的呼叫，CLOSE 则表示客服MM已经下班了。

* **消息系统**

在 A 和 B 之间搭建 IM 消息系统也是必不可少的，一方面，如果 A 和 B 中某一方网络发生异常，那么文本消息可以用极低的带宽占用维持最基本的消息通讯；另一方面，消息系统对于事件的传递要比音视频通道更加可靠。

现代实时音视频系统一般都有数据通道和信令通道两个传输通道，这样设计的原因是数据通道并不适合用于传输信令，比如 B 端的  通知音视频数据没有了，可能原因是 A已经挂断，但也有可能是 A 的网络出现了长时间的波动。而基于消息系统的“挂断事件”则不需要考虑这种不确定性问题。



基于以上原因，我们推荐您参考 **[RTCRoom](https://cloud.tencent.com/document/product/454/12554)** 方案，它是我们腾讯视频云团队基于pusher标签和player标签所实现的一套开源接入方案，它包含房间管理、消息系统 和 状态管理 等组成部分，而且支持 [**一键部署**](https://cloud.tencent.com/document/product/454/12554)，非常适合用于参考和调试。



## RTCROOM

RTCRoom（RealTime ChatRoom）存在的意义在于封装掉双人或者多人音视频实现过程中需要考虑的各种细节逻辑问题，比如房间管理、状态同步，消息收发等等，让您只需要面对几个非常简单的接口，从而快速构建自己的音视频能力。

### **流程解读** ![rtc3](res\rtc3.png)



### **Client**

RTCRoom 的 Client 部分（ActiveX插件上的的 RTCRoom 是一个叫做 rtcroom.js 的 javascript 文件） 提供了一组 API 接口：

- **CreateRoom** 

  创建一个双人（或多人）视频通话房间，调用这个接口的人即为创建者。


- **EnterRoom**

  进入一个已经创建好的视频通话房间，调用这个接口的人即为参与者。


- **ExitRoom**

  退出一个视频通话房间，在我们的默认实现中，如果是创建者退出，房间将被解散，您可以根据自己的需要进行调整。


- **startLocalPreview**

  启动本地视频预览

- **addRemoteView**

  设置播放视频渲染区域

- **SendTxtMsg**

  发送文本消息，用于作为视频交流的辅助手段，通常是用来发送一些不重要的系统通知。


- **事件通知**

  事件通知，比如新的与会者加入，或者有人离开，等等。

- ActiveX插件的RTCRoom内部进行< object id="pusher">和< object id="player">管理，需要推流时，调用startLocalPreview，并设置一个< div>(区域块)的id。需要拉流播放时，调用addRemoteView，并设置一个< div>(区域块)的id。

- 更多参考[RTCRoom接口文档](RTCRoom接口文档.md)



### **Server**

- **列表管理**

  RTCRoom 的 Server 部分是一组用于**房间列表管理**和**成员列表管理**的简单代码实现。以视频会议为例，一个公司同时可能会有多个进行中的视频会议，那么每一个会议都是一个房间，每一个房间里又有多个与会者。所以对于房间的管理和对于房间中成员的管理就是 Server 部分的工作。


- **事件通知**

  同时，Server 还有一个重要职责，就是当房间解散以及成员进出时，通过 IM 消息通道通知房间里的各个成员。由于腾讯云已经有非常成熟的 IM 通讯解决方案，所以我们直接复用之。


- **心跳机制**

  考虑到商用解决方案应当尽量避免端口限制，因此我们并没有采用时下比较流行的websocket 技术，而是基于简单的 http 协议实现后台接口，因为我们多实现了一个简单的心跳机制，以避免某个终端在崩溃或者异常退出时能够被 Server 感知到。

  ​


## **源代码下载**

RTCRoom 是一套开源实现，在 iOS，Android，Windows、ActiveX插件、小程序以及服务器端均有一套示例源码。其中客户端的源码主要是提供 CreateRoom、EnterRoom、ExitRoom 等进出房间的接口，而服务端源码则用于房间管理，并通过腾讯云通讯（IM）服务向房间内成员发送事件通知。

| 操作系统      | 下载链接                                     | 源码位置                             |
| --------- | ---------------------------------------- | -------------------------------- |
| IOS       | [DOWNLOAD](https://cloud.tencent.com/document/product/454/7873#iOS) | SDK开发包 RtcRoom.m                 |
| Android   | [DOWNLOAD](https://cloud.tencent.com/document/product/454/7873#Android) | SDK开发包 RtcRoom.java              |
| Windows   | [DOWNLOAD](https://cloud.tencent.com/document/product/454/7873#Windows) | Demo源码中的RTCRoom.h+RTCRoom.cpp    |
| ActiveX插件 | [DOWNLOAD](https://cloud.tencent.com/document/product/454/7873#Windows) | Window源码中ActivX插件demo:rtcroom.js |
| 小程序       | [DOWNLOAD](https://cloud.tencent.com/document/product/454/7873#XiaoChengXu) | 小程序源码zip包中的wxlite文件夹             |
| 服务器       | [DOWNLOAD](https://cloud.tencent.com/document/product/454/7873#XiaoChengXu) | 小程序源码zip包中的server文件夹             |



## **源代码下载**

下载源码只需要点几下鼠标，但是让 RTCRoom 跑起来却未必是件容易的事情，尤其是在您没有服务器的情况下。考虑到这一点，我们提供了免费的[一键部署](https://cloud.tencent.com/document/product/454/12554)服务，您只需要免费开通几项腾讯云服务，即可在 5 分钟时间内快速搭建出自己的调试环境。















