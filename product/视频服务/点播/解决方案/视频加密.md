视频内容版权保护，对于在线教育、行业培训等领域都是十分重要的。视频文件的泄露，有可能造成十分严重的经济损失。

传统的视频服务提供商大多是通过各种各样的防盗链机制来实现视频内容保护。该方案的基本原理是：APP服务端给客户派发专属的视频URL，CDN服务校验URL中参数的合法性，如果校验通过，则吐出视频数据；否则返回403。

但是，对于需要付费观看的视频，一旦恶意用户通过一次付费行为拿到了合法的防盗链播放URL，其便可以将视频完整下载到本地，进而实现二次分发。因此，防盗链方案对于视频版权保护是远远不够的。要进一步提升视频内容的保护程度，就不能仅仅在视频的分发URL上做文章，而是必须对视频数据本身的加密。

腾讯云视频加密服务目前正处于内侧阶段。如果需要试用，请提需求工单进行开通。

## 腾讯云点播视频加密方案

### 加密算法
点播系统目前支持标准HLS加密方式，该方案的安全级别可以达到：
1. 使用AES-128对视频内容本身进行加密；
1. 支持对单个视频文件使用多个秘钥进行加密，避免单个秘钥泄露导致整个文件泄密。

### 播放器适配性
腾讯云点播视频加密方案能够支持H5和Flash平台的各种播放器。

## 整体架构
![](//mc.qcloudimg.com/static/img/b88e3ed66a8d1856501554465454ccb7/image.png)

## 准备工作

### 建立秘钥管理服务（KMS）
秘钥管理服务主要用于管理视频秘钥。点播服务需要用到KMS系统的接口包括：

1. 生成数据秘钥用于视频加密（架构图中第II步）；这一步将返回用于视频加解密的对称秘钥（DataKey，简称DK），以及加密之后的秘钥（EncryptedDataKey，简称EDK）。能够接触到DK的角色包括：点播转码服务、APP后台、经过合法身份校验的最终用户。EDK可以分发给任意用户，但通过EDK获取DK这一步，必须由APP后台进行身份校验（架构图中的第4步）。
1. 根据EDK获取DK来进行数据播放。即架构图中的第4步。APP后台在通过用户的身份验证之后，需要调用KMS相关接口，使用EDK去获取DK，即架构图中的第5步。

腾讯云点播系统支持以下三种秘钥管理服务：

1. 腾讯云点播内置KMS服务：为最大限度地降低开发者的接入成本，腾讯云点播服务内部集成了KMS服务，并且提供了最简单的调用接口。如果使用点播内置KMS服务，则在整个视频加密方案中，APP后台与KMS服务唯一需要交互的地方在于获取解密秘钥（架构图中的第5步）。
2. 腾讯云KMS服务（即将支持）：在开通腾讯云KMS服务之后，您可以将根据某个主秘钥来生成数据秘钥的权限授权给点播服务，点播系统便可融入您在云端的秘钥管理体系中。
3. 自建KMS服务（即将支持）：如果您已经自建了KMS服务，您可以在每次加密操作中自行指定DK和EDK，从而达到最灵活的秘钥控制级别。

### 搭建鉴权与秘钥分发服务

对于已经加密的视频，只有经过APP后台认证过的客户端才能得到解密秘钥。因此，最终客户获取秘钥的行为必须要有APP后台参与鉴权。该服务的主要业务逻辑是：
1. 对于客户端端携带EDK获取播放秘钥的请求（架构图中第4步），对请求方进行身份认证；
2. 如果身份认证通过，则去KMS系统查询对应的DK（架构图中第5步），并返回给客户端。

建议：
1. APP后台可以缓存EDK和DK之间的对应关系，以降低调用KMS系统的次数（即降低架构图中第5步的调用）；
2. APP后台给客户端的应答，可以增加缓存控制参数，以降低客户端到APP后台获取DK的次数（即降低架构图中第4步的调用）。

### 配置视频加密模板
为确保点播后台能够进行正确的加密操作，您需要配置视频加密模板。详情参见视频加密参数模板。


## 业务流程

## 视频上传
可以通过服务端上传、客户端上传、控制台上传、录制上传等方式来将已有视频文件上传到点播平台。

## 视频加密

视频加密主要分为以下四个步骤：

### I. APP后台发起视频加密。
视频加密操作是点播任务流体系中的一部分，您可以通过如下几种方式对视频文件进行加密：

**调用“对视频文件进行处理”接口进行加密**

对视频文件进行处理接口支持在转码控制参数中传入视频加密模板。

如下示例的含义是：
对视频文件进行转码，转码目标输出模板为10、20、30、40；禁止从较低码率转为较高码率；转码过程使用加密模板10进行加密；事件通知模式为：待整个事件执行完毕之后发起一次事件通知。

```
https://vod.api.qcloud.com/v2/index.php?Action=ProcessFile
&transcode.definition.0=10
&transcode.definition.1=20
&transcode.definition.3=30
&transcode.definition.4=40
&transcode.disableHigherBitrate=1
&transcode.drm.definition=10
&notifyMode=Finish
&COMMON_PARAMS
```

**在任务流中配置加密任务**
即将支持。

### II. 点播平台获取加密秘钥。
点播平台将根据您所指定的加密参数模板，获取相应的加密秘钥。

### III. 点播平台发起视频加密转码。
点播平台依照上一步获取的加密秘钥，对视频文件进行加密。
需要注意的是：视频加密完成后，视频源文件将处于“禁播”状态，无法通过源文件URL获取到视频。详情参见媒资管理。

### IV. 点播平台发起加密完成回调。
包含加密操作的任务流状态发生变化（或者执行完毕）之后，点播平台将发起任务流状态变更通知。

## 媒资管理
TODO。视频加密被加密之后的状态，调用媒资管理接口会返回什么。

## 视频播放

### 1. 登录并派发用于身份校验的Cookie
只有经过合法身份认证的客户才应当得到视频解密秘钥。因此在视频播放之前，客户端必须进行登录操作，并由APP服务端给客户端派发签名。例如，客户端通过login.example.com进行账号密码登录，APP后台在通过身份认证之后，给客户端下发example.com域的cookie来标识用户身份。

### 2. 获取指定视频的多码率播放地址
腾讯云点播Web端视频播放器提供了多码率播放能力，即可以根据FileID获取一个视频对应的多码率播放地址。如果您使用了其他播放器，则必须自行获取多码率播放地址。

### 3. 获取视频内容(已加密)
当开始播放视频时，视频播放器会自动发起这一步。

视频播放器开始播放视频时，会从点播CDN边缘节点请求视频数据文件。对于HLS格式的视频，播放器会根据m3u8文件中的EXT-X-KEY标签来获取视频解密秘钥。例如，EXT-X-KEY标签中获取视频解密秘钥的URL为`https://getkey.example.com?fileId=123456&edk=abcdef`。则当播放器获取解密秘钥dk时，会带上第1步由APP后台派发的example.com域的cookie。

### 4 & 5. 获取视频解密秘钥（携带身份验证Cookie）

当播放器获取到视频索引文件（m3u8文件）之后，会在播放视频文件之前自动发起第4步。

APP后台在收到客户端的请求之后，首先对cookie中的身份认证标识进行校验。如果用户身份非法，则直接拒绝请求；否则，KMS系统中根据指定的EDK获取DK，并返回给客户端。

以上步骤均完成之后，客户端便拿到了视频解密秘钥，从而可以进行正常的视频解密与播放。


### 视频脱密

敬请期待。