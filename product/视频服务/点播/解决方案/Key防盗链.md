## 功能介绍
* Key 防盗链允许用户在播放地址中加入一些关键参数，并对播放地址进行签名。只要用户密钥不泄露，其他用户无法伪造签名。
* CDN 节点对播放请求中的参数和签名进行校验，实现用户对访客播放行为的控制。
* 防盗链播放地址拥有过期时间，其他用户无法获取后无法长期使用。
* 防盗链播放地址中可以带有试看时长参数，为视频播放实现试看功能。

## 配置向导
腾讯云点播控制台 -> 全局设置 -> 域名设置 -> 防盗链设置。

![图片描述](https://mc.qcloudimg.com/static/img/cf5a076e57d3287852bf4ab3fe609bbe/image.png)

启用 Key 防盗链 -> 生成 KEY -> 确定。

![图片描述](https://mc.qcloudimg.com/static/img/12e25bcc2cd7dd87aec2067a5c2910a3/image.png)

保存配置后，大概需要5分钟使所有 CDN 节点生效该配置。

## 防盗链生成
在控制台开启 Key 防盗链后，所有视频的原始播放地址将不再能播放，而需要构造出 Key 防盗链播放地址。
Key 防盗链播放地址是在原始播放地址后 QueryString 构成的，形如：
```
http://example.vod2.myqcloud.com/dir1/dir2/myVideo.mp4?t=[t]&us=[us]&sign=[sign]
```
下面，将详细介绍 Key 防盗链播放地址各参数的含义及播放地址的生成方式。

### 防盗链参数
| 参数名 | 必选 | 说明 | 备注 |
| --- | --- | --- | --- | --- |
| KEY | 是 | 开启 Key 防盗链时填写的密钥，必须为大小写字母（a-Z）或者数字（0-9）组成，长度在8-20个字符之间 | 建议在控制台中点击“生成 KEY”按钮生成 |
| Dir | 是 | 原始播放地址的 PATH 中除去文件名的那部分路径 | 假设原始播放地址为 `http://example.vod2.myqcloud.com/dir1/dir2/myVideo.mp4`，则播放路径为 `/dir1/dir2/`  |
| t |  是 | 播放地址的超时时间戳，以Unix时间的16进制小写形式表示。超时后该播放地址将不再有效，返回 403 响应码 | 过期时间戳不要过短，使视频有足够时间完整播放 |
| exper | 否 | 试看时长，单位为秒，以十进制表示 | 不填或者填0表示不试看（即返回完整视频），exper 不要超过视频原始时长 |
| us | 否 | 链接标识，用于随机化一个播放地址，增强链接的唯一性 | 建议每次派发播放地址时，指定一个随机的 us 值 （可以使用当前时间戳） |
| sign | 是 | 防盗链签名，用于 CDN 节点校验防盗链合法性，签名校验失败将返回 403 响应码 | 无 |

### 签名计算公式
```
sign = md5(KEY + Dir + t + exper + us)
```
公式中，`+` 代表字符串拼接，`exper` 和  `us` 为选填参数可以不填。

### 防盗链地址示例
确定了视频的原始播放地址和防盗链参数后，将选定的防盗链参数（不包括 `KEY` 和 `Dir`）按照 `t`，`exper`，`us`，`sign` 的顺序（不可乱序）拼接在原始播放地址的 QueryString 中，即可得到防盗链播放地址。下面结合两个示例介绍如何生成防盗链播放地址。

#### 示例1：视频播放地址有效时间控制
* 防盗链参数 `t` 指定了视频播放地址的过期时间，即实现了视频播放地址的有效时间控制。如果视频播放地址过期，请求该地址将返回403错误。
* 假设当前是按是2018年1月31日12:00整（Unix 时间为1517371200），希望播放地址的有效期为8个小时（即在2018年1月31日20:00整过期，Unix 时间为1517400000），则 `t` 的取值为 `5a71afc0`（1517400000的十六进制小写表示）。
* 假设用户开通 Key 防盗链时使用的密钥 `KEY` 是 `24FEQmTzro4V5u3D5epW`，视频的原始播放地址是 `http://example.vod2.myqcloud.com/dir1/dir2/myVideo.mp4`，则播放路径 `Dir` 为  `/dir1/dir2/`。
* 链接标识 `us` 可以是当前 Unix 时间 `1517371200`。
* 根据签名 `sign` 的计算公式，对 `24FEQmTzro4V5u3D5epW/dir1/dir2/5a71afc01517371200`（即 `24FEQmTzro4V5u3D5epW`，`/dir1/dir2/`，`5a71afc0` 和 `1517371200` 的拼接结果）做 md5 后得到签名值 `740e5e929b2bbecaa091a040a9cd9ba6`。
* 最终，防盗链播放地址为 `http://example.vod2.myqcloud.com/dir1/dir2/myVideo.mp4?t=5a71afc0&us=1517371200&sign=740e5e929b2bbecaa091a040a9cd9ba6`。在有效期内，该播放地址可以正常播放。

#### 示例2：视频允许播放时长控制
* 防盗链参数 `exper` 指定了视频的试看时长，即实现了对视频允许播放时长的控制。
* 假设原始视频时长有1小时30分钟，希望生成一个只允许试看5分钟的播放地址，则 `exper` 的值为 `300` （试看时间为300秒）。
* 假设当前是按是2018年1月31日12:00整（Unix 时间为1517371200），希望播放地址的有效期为8个小时（即在2018年1月31日20:00整过期，Unix 时间为1517400000），则 `t` 的取值为 `5a71afc0`（1517400000的十六进制小写表示）。
* 假设用户开通 Key 防盗链时使用的密钥 `KEY` 是 `24FEQmTzro4V5u3D5epW`，视频的原始播放地址是 `http://example.vod2.myqcloud.com/dir1/dir2/myVideo.mp4`，则播放路径 `Dir` 为  `/dir1/dir2/`。
* 链接标识 `us` 可以是当前 Unix 时间 `1517371200`。
* 根据签名 `sign` 的计算公式，对 `24FEQmTzro4V5u3D5epW/dir1/dir2/5a71afc03001517371200`（即 `24FEQmTzro4V5u3D5epW`，`/dir1/dir2/`，`5a71afc0`，`300` 和 `1517371200` 的拼接结果）做 md5 后得到签名值 `52c83126ba5d7241ef8828661659f82d`。
* 最终，防盗链播放地址为 `http://example.vod2.myqcloud.com/dir1/dir2/myVideo.mp4?t=5a71afc0&exper=300&us=1517371200&sign=52c83126ba5d7241ef8828661659f82d`。在有效期内，该播放地址可以正常播放，且能播放的视频只有前5分钟。

### Key 防盗链生成和校验工具
* [Key 防盗链视频播放地址生成工具](https://video.qcloud.com/referer/gen_video_url.html)
* [Key 防盗链视频播放地址校验工具](https://video.qcloud.com/referer/check_sign.html)

点播为用户提供了 Key 防盗链视频播放地址的生成工具和校验工具，用户可以使用该工具快捷准确地生成和校验符合要求的 Key 防盗链播放地址。

## 注意事项
* 该功能为可选项，默认不启用。
* 启用该功能后，原始播放地址将不再能直接播放，需要按规则生成合法的防盗链播放地址。
* 密钥 KEY 必须为大小写字母（a-Z）或者数字（0-9）组成，长度在8-20个字符之间。
* 若请求防盗链地址过期，或者签名不能通过，将无法播放视频，并返回403响应码。
* 防盗链地址中 QueryString 中各参数必须按照 `t`，`exper`，`us`，`sign` 的顺序出现，如果顺序不正确将无法播放视频。
* 考虑到机器之间可能存在时间差，防盗链的实际过期时间一般比防盗链中指定的过期时间长5分钟，即额外给出300秒的容差时间。
* 如果使用试看功能，需确保试看时间不大于视频时长，否则将导致视频无法播放。
* 试看对视频的格式有较严格的要求（仅支持H264，视频元信息在视频文件的头部等），不符合格式要求的原始视频使用试看功能将产生异常。建议使用点播转码功能进行转码，对转码后视频设置试看（转码后的格式均符合试看格式要求）。