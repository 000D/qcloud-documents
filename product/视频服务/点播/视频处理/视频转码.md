所谓视频转码（Video Transcoding），是指将一个视频码流转换成另一个视频码流，以适应不同的网络带宽、不同的终端处理能力和不同的用户需求。点播系统中的转码一般称为离线转码；对应的，直播系统中的转码称为即时转码。

离线转码的典型应用场景包括：

- 终端适配：
    - 将特定格式的视频转换成终端适配能力较高的视频，以便在最广泛的终端上实现分发；例如，将AVI格式（对网络播放支持不友好）的视频转码成MP4（几乎所有网络播放器都支持），以便在互联网上进行分发；
- 带宽适配：
    - 将视频转码为超清、高清、标清等多路不同码率的视频，以便不同网络带宽的用户选择不同码率的视频；
- 播放友好：
    - 优化视频封装格式，以实现更好地播放效果；例如，某些MP4文件的MOOV头可能位于尾部，导致部分播放器需要下载整个MP4文件之后才能开始播放；可以通过转码将MOOV头调整到文件头部，以便播放器无需下载整个文件便可以开始播放；
- 增加水印：
    - 在视频中增加版权相关图片（例如电视台的台标），宣示视频本身的版权归属；
- 降低分发带宽：
    - 使用更先进的编码方式对视频进行编码，确保在不降低画质的前提下降低视频码率，从而达到节省带宽的目的；例如对原本使用H.264编码的视频进行H.265转码；
- 降低存储成本：
    - 对于以归档、备案为目的的视频，直接存储原始视频可能会带来较高的存储成本，此时可以将视频转为低码率进行存储，从而大幅降低视频存储成本。

TODO：样本视频。

## 视频转码

### 转码能力综述

- 视频格式
    - 输入格式
    - 输出格式
    - 纯音频输出
    - 纯视频输出
    - 转封装
- 视频编码参数
    - 编码格式
    - 码率
    - 帧率
    - 分辨率
    - 自动缩放
    - GOP长度
    - 编码档次
    - 色度空间
- 视频处理参数
    - 视频降噪
    - 去隔行扫描
    - 编码模式
- 音频编码参数
    - 编码格式
    - 采样率
    - 码率
    - 通道数
- 音频处理参数
    - 音频重新采样
- 转码控制
    - HLS MasterPlayList
    - 禁止码率低转高
    - 转码流程可编程化
- 其他能力
    - 视频加密


### 转码模板

视频处理的参数较多，故而点播系统使用转码模板来作为各种转码参数的容器，在进行视频处理时，只需指定转码模板即可。

为方便开发者的调用，点播系统预设了一批转码模板，参见[预置转码模板](#.E9.A2.84.E7.BD.AE.E8.BD.AC.E7.A0.81.E6.A8.A1.E6.9D.BF)；如果预设转码模板无法无法满足需求，开发者亦可根据自己的需求自定义转码模板。

### 通过控制台管理转码模板
当前暂不支持通过控制台管理转码模板，敬请期待。

### 通过服务端API管理转码模板
参见服务端API：
- [创建转码模板(CreateTranscodeTemplate)](/document/product/266/9910)
- [更新转码模板(UpdateTranscodeTemplate)](/document/product/266/9911)
- [查询转码模板详情(QueryTranscodeTemplate)](/document/product/266/9912)
- [查询转码模板列表(QueryTranscodeTemplateList)](/document/product/266/9913)
- [删除转码模板(DeleteTranscodeTemplate)](/document/product/266/9914)


### 发起转码

#### 在点播控制台发起转码
文档完善中。

#### 通过服务端API发起转码
参见：
- [使用任务流处理视频](/document/product/266/11700#.E4.BD.BF.E7.94.A8.E4.BB.BB.E5.8A.A1.E6.B5.81.E5.A4.84.E7.90.86.E8.A7.86.E9.A2.91)
- 服务端API：[视频转码(ConvertVodFile)](/document/product/266/7822)

> 注意：
> 在调用服务端API进行转码时，推荐使用任务流而非独立的视频转码接口。

## 视频转封装
所谓视频转封装，是指不改变视频的编码方式，而仅改变封装格式。例如将HLS视频转封装为MP4，以便于下载到本地进行编辑。

转封装可以认为是一种比较特殊的转码。发起视频转封装的方式视频转码相同，参见[发起转码](#.E5.8F.91.E8.B5.B7.E8.BD.AC.E7.A0.81)。

点播系统预设了一组转码模板来支持转封装，参见[预置转封装模板]。(#.E9.A2.84.E7.BD.AE.E8.BD.AC.E5.B0.81.E8.A3.85.E6.A8.A1.E6.9D.BF)。

## 视频水印

所谓视频水印，即在视频中增加版权相关图片（例如电视台的台标），宣示视频本身的版权归属。在视频转码过程中，可以指定[水印模板](#.E6.B0.B4.E5.8D.B0.E6.A8.A1.E6.9D.BF)来为输出的视频文件增加水印。

### 水印类型

点播系统支持两种水印：
- 静态水印：
    - 使用一张图片作为水印，该图片固定位于视频的某个位置，从片头贯穿到片尾；支持JPG和PNG两种格式的水印图片，推荐使用PNG格式图片；
- 动态水印：
    - 使用[APNG](https://zh.wikipedia.org/wiki/APNG)动图作为水印，该动画图片位于视频的固定位置循环播放。

### 水印位置

水印位置是通过left, top, width, height四个参数决定的，如下图所示：

![水印位置参数示意图](//mc.qcloudimg.com/static/img/c030e8efdcdda7c6abbd7875dbc68d7c/image.png)

各参数含义如下：
- 参数left：决定水印左侧到视频左侧的距离；
- 参数top：决定水印顶部到视频顶部的距离；
- 参数width：决定水印图片的宽度；
- 参数height：决定水印图片的高度。

四个参数均支持两种计算方式：

1. 以像素为单位进行计算；
1. 以相对视频宽度/高度的百分比进行计算，即：
    1. left和width支持以视频宽度的百分比来计算；
    1. top和height支持以视频高度的百分比来计算。

如果仅指定width而不指定height，则意味着保持原始水印图片的宽高比。

举例：
> 假设需要添加水印的视频文件分辨率为1280 × 720，水印图片的分辨率为100 × 100，则：
> - left为100px，意味着水印左侧距离视频左侧为100像素；
> - top为10%，意味着水印顶部到视频顶部的距离为视频高度的10%，即128像素(1280 × 10% = 128)；
> - 指定width为5%，不指定height，意味着水印的宽度为64像素(1280 × 5% = 64)，高度为64像素（水印图片宽高比为1 : 1，故而水印的高度与宽度相同，亦为64像素）。

在进行多码率转码的情况下，如果需要保持各个码率的视频水印大小、位置相同，建议使用百分比为单位来衡量。

### 水印模板

视频水印的参数较多，故而点播系统使用水印模板来作为各种水印参数的容器。如果在转码过程中需要为视频增加水印，只需指定水印模板即可。

开发者可以通过控制台和服务端API来管理水印模板。

### 通过控制台管理水印模板
文档完善中。

### 通过服务端API管理水印模板

通过服务端API创建水印模板分为三步：
1. 调用[申请上传水印文件(ApplyUploadWatermark)](/document/product/266/11607)接口，申请水印文件的上传URL；
1. 使用HTTP PUT方法，将水印文件上传到上一步返回的上传URL，请求Body为水印图片的二进制数据；
1. 调用[创建水印模板(CreateWatermarkTemplate)](/document/product/266/11599)接口，创建水印模板。

第2步上传水印文件的示例如下：
假定调用ApplyUploadWatermark返回的URL为`http://123.test.com/123.png&sign=abcd`，要上传的本地水印文件为`123.png`，则使用curl上传水印文件的操作为：

<pre>
curl 'http://123.test.com/123.png&sign=abcd' --upload-file 123.png
</pre>

参见：
- [申请上传水印文件(ApplyUploadWatermark)](/document/product/266/11607)
- [创建水印模板(CreateWatermarkTemplate)](/document/product/266/11599)
- [更新水印模板(UpdateWatermarkTemplate)](/document/product/266/11605)
- [查询水印模板详情(QueryWatermarkTemplate)](/document/product/266/11606)
- [查询水印模板列表(QueryWatermarkTemplateList)](/document/product/266/11608)
- [删除水印模板(DeleteWatermarkTemplate)](/document/product/266/11604)

## 预置转码模板

### 预置H.264转码模板

TODO：
1. 增加4K、2K；
1. 解释“按原视频的DAR或PAR缩放（DAR优先）”；
1. Profile，是一样的，还是不一样？几个FLV的模板，是否和其他的一致？

<table style="display:table">
    <tr>
        <td rowspan=2>
            规格名称                
        </td>
        <td rowspan=2>
            模板ID                
        </td>
        <td rowspan=2>
            封装格式(Format)
        </td>
        <td colspan=3>    
            视频参数
        </td>
        <td colspan=1>    
            音频参数
        </td>
    </tr>
    <tr>
        <td>
            分辨率(Resolution)
        </td>
        <td>
            码率(Bitrate)
        </td>
        <td>
            档次(Profile)
        </td>
        <td>
            编码器(Codec)
        </td>
    </tr>
    <tr>
        <td rowspan=3>
            手机
        </td>
        <td>
            10
        </td>
        <td>
            MP4
        </td>
        <td>
            320 × 240
        </td>
        <td>
            256kbps
        </td>
        <td>
            Baseline
        </td>
        <td>
            ACC
        </td>
    </tr>
    <tr>
        <td>
            210
        </td>
        <td>
            HLS
        </td>
        <td>
            320 × 240
        </td>
        <td>
            256kbps
        </td>
        <td>
            Baseline
        </td>
        <td>
            ACC
        </td>
    </tr>
    <tr>
        <td>
            10046
        </td>
        <td>
            FLV
        </td>
        <td>
            320 × 240
        </td>
        <td>
            256kbps
        </td>
        <td>
            Baseline
        </td>
        <td>
            MP3
        </td>
    </tr>
    <tr>
        <td rowspan=3>
            标清(LD)
        </td>
        <td>
            20
        </td>
        <td>
            MP4
        </td>
        <td>
            640 × 480
        </td>
        <td>
            512kbps
        </td>
        <td>
            Main
        </td>
        <td>
            ACC
        </td>
    </tr>
    <tr>
        <td>
            220
        </td>
        <td>
            HLS
        </td>
        <td>
            640 × 480
        </td>
        <td>
            512kbps
        </td>
        <td>
            Main
        </td>
        <td>
            ACC
        </td>
    </tr>
    <tr>
        <td>
            10047
        </td>
        <td>
            FLV
        </td>
        <td>
            640 × 480
        </td>
        <td>
            512kbps
        </td>
        <td>
            Main
        </td>
        <td>
            MP3
        </td>
    </tr>
    <tr>
        <td rowspan=3>
            高清(SD)
        </td>
        <td>
            30
        </td>
        <td>
            MP4
        </td>
        <td>
            1280 × 720
        </td>
        <td>
            1024kbps
        </td>
        <td>
            High
        </td>
        <td>
            ACC
        </td>
    </tr>
    <tr>
        <td>
            230
        </td>
        <td>
            HLS
        </td>
        <td>
            1280 × 720
        </td>
        <td>
            1024kbps
        </td>
        <td>
            High
        </td>
        <td>
            ACC
        </td>
    </tr>
    <tr>
        <td>
            10048
        </td>
        <td>
            FLV
        </td>
        <td>
            1280 × 720
        </td>
        <td>
            1024kbps
        </td>
        <td>
            High
        </td>
        <td>
            MP3
        </td>
    </tr>
    <tr>
        <td  rowspan=3>
            超高清(HD)
        </td>
        <td>
            40
        </td>
        <td>
            MP4
        </td>
        <td>
            1920 × 1080
        </td>
        <td>
            2500kbps
        </td>
        <td>
            High
        </td>
        <td>
            ACC
        </td>
    </tr>
    <tr>
        <td>
            240
        </td>
        <td>
            HLS
        </td>
        <td>
            1920 × 1080
        </td>
        <td>
            2500kbps
        </td>
        <td>
            High
        </td>
        <td>
            ACC
        </td>
    </tr>
    <tr>
        <td>
            10049
        </td>
        <td>
            FLV
        </td>
        <td>
            1920 × 1080
        </td>
        <td>
            2500kbps
        </td>
        <td>
            High
        </td>
        <td>
            MP3
        </td>
    </tr>
</table>

以上转码模板，未注明参数参数全部相同，分别是：

TODO:
- 视频格式
    - 输入格式
    - 输出格式
    - 纯音频输出
    - 纯视频输出
- 视频编码参数
    - 编码格式
    - 码率
    - 帧率
    - 分辨率
    - 自动缩放
    - GOP长度
    - 编码档次
    - 色度空间
- 视频处理参数
    - 视频降噪
    - 去隔行扫描
    - 编码模式
- 音频编码参数
    - 编码格式
    - 采样率
    - 码率
    - 通道数
- 音频处理参数
    - 音频重新采样

### 预置H.265模板
TODO：增加H.265模板

### 预置转封装模板
TODO：转封装模板