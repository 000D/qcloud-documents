 
本案例演示如何在不搭建后台服务情况下完成对象存储文件上传时自动转码，其中使用了腾讯云[对象存储](https://cloud.tencent.com/product/cos)，[无服务器云函数](https://cloud.tencent.com/product/scf)，[点播系统独立转码](https://cloud.tencent.com/document/product/266/2833)三个功能，当配置完成后，您将视频上传到某个特定的 COS Bucket，通过无服务器云函数调用点播系统转码功能，当完成转码时点播系统将转码后的输出文件保存至另外一个 COS Bucket。如果有特殊逻辑如需要对不同类型文件完成不同参数转码，可以通过修改无服务器函数代码达到目的。
![SCF 调用独立转码框架图](https://main.qcloudimg.com/raw/24b3d2b6ce152671251b60d4f828dcac.png)
## 准备对象存储存储桶
1. 登录腾讯云控制台，选择[【对象存储服务】](https://console.cloud.tencent.com/cos5/bucket)。
2. 点击【存储桶列表】选项卡下的【创建Bucket】按钮，新建源 COS Bucket。
3. 设置 COS Bucket 的名称为`inputbucket`，选择地域为【北京】，设置访问权限为默认值公有读私有写，点击【保存】按钮新建一个 COS Bucket，并在`inputbucket` 下新建文件夹`video`.
4. 按照相同的方式在【北京】地域下创建输出 Bucket`outputbucket`,并在改`outputbucket` 下新建文件夹`video`.
5. 进入【存储桶列表】，点击刚创建的`outputbucket`，进入【权限配置】选项，在存储桶访问权限下点击【添加用户】，帐号ID填写 `2819697038`，【权限】选择【数据写入】，点击【保存】。

![COS Bucket 权限设置](https://main.qcloudimg.com/raw/ae4be63c286b1b8ffc6d2218284fdd25.png)

## 创建部署程序包
下载点播提供的无服务器云代码模版，解压文件夹，修改配置文件参数 config.json，将 SecretId和 SecretKey修改为您的实际参数，并将代码打包成 `RequestVideoTranscodeDemo.zip`。

``` 
{
    "SecretId":"your secretId",
    "SecretKey":"your secretKey",
    "outpuBucket":"outputbucket",
    "outputPath":"/video/",
    "mediaProcess":{
        "transcode":{
            "definition":[72782]
        }
    }
}
``` 

## 创建无服务器云函数
1. 登录[【无服务器云函数控制台】](https://console.cloud.tencent.com/scf)，在【北京】地域下点击【新建】按钮；
2. 进入【函数配置】选项，函数名称填写`RequestVideoTranscodeDemo`，运行环境选择 Nodejs 6.10，超时时间设置为10s，其余保持默认值，点击【下一步】；
3. 进入【函数代码】选项，选择【本地上传zip包】。执行方法填写`index.main_handler`，选择上述步骤创建部署程序包中创建的 `RequestVideoTranscodeDemo.zip`，点击【下一步】；
4. 进入【触发方式】部分，点击【添加触发器】，触发方式选择 【COS触发】，COS Bucket选择第一步创建的`inputbucket`，【事件类型】选择文件上传，点击【保存】后完成触发器创建，点击【完成】。

## 测试
1. 完成上述三个步骤后，登录腾讯云控制台，选择[【对象存储服务】](https://console.cloud.tencent.com/cos5/bucket)【存储桶列表】，进入`inputbucket`存储桶，点击【上传文件】，上传一个视频文件(大小不超过1M以便尽快查看转码结果)。
2. 登录[【无服务器云函数控制台】](https://console.cloud.tencent.com/scf)【函数服务】，进入 `RequestVideoTranscodeDemo` 函数，点击【日志】，查看日志记录是否记录转码请求，日志包括请求参数和请求返回结果，返回结果中的`vodTaskId为`请求任务标识，可用来查询载入执行信息。若请求已经发起，则一段时间后可观察到`outputbucket`存储桶有转码文件生成。
![](https://main.qcloudimg.com/raw/2edf0c22ae509d397c8293a0821e486b.png)


``` 
注意：
1. 源 COS Bucket和输出 COS Bucket必须在同一地域。
2. 无服务器云函数地域需要与源COS Bucket地域相同，若源 COS Bucket在【北京】，则需要在【北京】地域下创建COS Bucket。
3. 目前通过 SCF转码发起只支持的地域为上海、北京，广州已准备上线。
4. 视频的上传和输出文件存储不要在更目录下。
5. 控制台操作有一点有一定延迟，如新建的 COS Bucket需要1分钟左右才能在 SCF COS 上传配置中拉取到。
``` 





