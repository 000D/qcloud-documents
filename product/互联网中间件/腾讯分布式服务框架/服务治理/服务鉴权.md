## 开启鉴权并新建规则

1. 登录 TSF 控制台。
2. 单击左侧导航栏 **服务治理**。
3. 单击服务列表的服务名，进入服务详情页。
4. 选择 **服务鉴权** 标签页，开启服务鉴权功能。
5. 单击【新增 tag 鉴权规则】按钮，配置鉴权规则。会依据应用代码中 `TsfContext.putTag` 接口设置的标签信息进行判定。多个鉴权规则间是逻辑与（AND）的关系，只有所有鉴权规则通过，才能通过鉴权。
6. 单击【保存】按钮。



#### 值字段与元素个数的关系

值字段的可填写的元素个数与匹配方式的关系如下：

| 匹配方式   | 值元素个数 | 鉴权规则说明                                                 |
| ---------- | ---------- | ------------------------------------------------------------ |
| 包含       | 多个       | 当服务消费者的 tag 的值出现在比较值中时，才能通过鉴权        |
| 不包含     | 多个       | 当服务消费者的 tag 的值 **未出现** 在比较值中时，才能通过鉴权 |
| 等于       | 一个       | 当服务消费者的 tag 的值等于比较值时，才能通过鉴权            |
| 不等于     | 一个       | 当服务消费者的 tag 的值 **不等于** 比较值时，才能通过鉴权    |
| 正则表达式 | 一个       | 当服务消费者的 tag 的值满足正则表达式时，才能通过鉴权        |



#### 鉴权原理

鉴权结果会依据应用代码中 `TsfContext.putTag` 接口设置的标签信息与控制台上填写的鉴权规则进行判定。多个鉴权规则间是逻辑与（AND）的关系，只有所有鉴权规则通过，才能通过鉴权。

例如，在应用代码中填写设置 `user` 的 tag。

```
TsfContext.putTags("user", "12345678", ControlFlag.TRANSITIVE, ControlFlag.NOT_IN_SLEUTH)
```

- tag 鉴权规则如下：

| 键   | 匹配方式 | 值       |
| ---- | -------- | -------- |
| user | 等于     | 12345678 |

鉴权结果：**通过**。

- tag 鉴权规则如下：

| 键   | 匹配方式 | 值       |
| ---- | -------- | -------- |
| user | 不等于   | 12345678 |

鉴权结果：**不通过**。

- 在控制台上设置的 tag 鉴权规则如下：

| 键   | 匹配方式 | 值                |
| ---- | -------- | ----------------- |
| user | 包含     | 12345678, 3494817 |

鉴权结果：**通过**。

- tag 鉴权规则如下：

| 键   | 匹配方式 | 值                |
| ---- | -------- | ----------------- |
| user | 不包含   | 12345678, 3494817 |

鉴权结果：**不通过**。

- tag 鉴权规则如下：

| 键   | 匹配方式   | 值   |
| ---- | ---------- | ---- |
| user | 正则表达式 | 12*  |

鉴权结果：**通过**。

- tag 鉴权规则如下：

| 键   | 匹配方式 | 值       |
| ---- | -------- | -------- |
| user | 等于     | 12345678 |
| user | 不等于   | 3494817  |

鉴权结果：**通过**。