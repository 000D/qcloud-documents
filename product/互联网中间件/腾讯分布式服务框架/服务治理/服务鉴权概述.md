服务鉴权是为了解决微服务之间相互访问的权限解决方案。服务提供者通过配置中心下发的鉴权规则来判断是否处理服务消费者的请求。目前 TSF 提供两种类型的服务鉴权规则：

- 基于服务名的鉴权规则：根据服务消费者的服务名决定是否通过鉴权模块。
- 基于 Tag 的鉴权规则：通过请求中携带的 Tag 参数来决定是否通过鉴权模块。

以下为基于 Tag 的鉴权流程：

1. 在服务消费者的业务代码中设置 tag 信息。
2. 通过 TSF 控制台下发鉴权规则给服务提供者。
3. 服务消费者在调用服务提供者的接口时，会带上 tag 信息。服务提供者的鉴权模块会根据鉴权规则和请求来判断鉴权是否通过，如果通过，继续处理请求；如果不通过，则返回未授权的响应（Unauthorized Response)。

![](https://main.qcloudimg.com/raw/c4f1a360d2fbab1c4924b391a3dc4787.png)



## 鉴权规则

#### 鉴权规则的关系

一个服务可能有多个鉴权规则，多个鉴权规则之间是逻辑与（AND）的关系。只有满足所有鉴权规则才会通过鉴权。当一条鉴权规则不通过时，就会返回未授权的响应。

```
request => 鉴权规则1 => 鉴权规则2 => ... => 鉴权规则 N => 鉴权结果
```



#### 匹配方式与值个数的关系

值字段的可填写的元素个数与匹配方式的关系如下：

| 匹配方式   | 值个数 |
| ---------- | ------ |
| 包含       | 多个   |
| 不包含     | 多个   |
| 等于       | 一个   |
| 不等于     | 一个   |
| 正则表达式 | 一个   |



#### 示例

例如，在应用代码中填写设置 `user` 的 tag。

```
TsfContext.putTags("user", "12345678", ControlFlag.TRANSITIVE, ControlFlag.NOT_IN_SLEUTH)
```

- tag 鉴权规则如下：

| 键   | 匹配方式 | 值       |
| ---- | -------- | -------- |
| user | 等于     | 12345678 |

鉴权结果：**通过**。

- tag 鉴权规则如下：

| 键   | 匹配方式 | 值       |
| ---- | -------- | -------- |
| user | 不等于   | 12345678 |

鉴权结果：**不通过**。

- 在控制台上设置的 tag 鉴权规则如下：

| 键   | 匹配方式 | 值                |
| ---- | -------- | ----------------- |
| user | 包含     | 12345678, 3494817 |

鉴权结果：**通过**。

- tag 鉴权规则如下：

| 键   | 匹配方式 | 值                |
| ---- | -------- | ----------------- |
| user | 不包含   | 12345678, 3494817 |

鉴权结果：**不通过**。

- tag 鉴权规则如下：

| 键   | 匹配方式   | 值   |
| ---- | ---------- | ---- |
| user | 正则表达式 | 12*  |

鉴权结果：**通过**。

- tag 鉴权规则如下：

| 键   | 匹配方式 | 值       |
| ---- | -------- | -------- |
| user | 等于     | 12345678 |
| user | 不等于   | 3494817  |

鉴权结果：**通过**。