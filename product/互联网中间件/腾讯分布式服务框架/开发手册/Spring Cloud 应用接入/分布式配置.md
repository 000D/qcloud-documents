## 准备工作

开始实践分布式配置功能前，请确保已完成了 [准备工作](https://cloud.tencent.com/document/product/649/16619)。使用分布式配置功能涉及到如下部分：

1. pom.xml 添加配置依赖项
2. 在代码中引用配置
3. 本地验证动态配置功能（可选）
4. 通过 TSF 平台下发动态配置



## 一、依赖项

添加 pom.xml 依赖：

```xml
<dependency>
	<groupId>org.springframework.cloud</groupId>
	<artifactId>spring-cloud-starter-consul-config</artifactId>
	<version>1.3.1.TSF-RELEASE</version>
</dependency>
 <!-- 使用分布式配置自动刷新功能，需要显示添加actuator的依赖包-->
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```



## 二、代码中引用配置

### 1. 使用配置类 @ConfigurationProperties 

在 `provider-demo` 的 ProviderNameConfig 类中，使用 `@ConfigurationProperties` 注解来标明这个类是一个配置类。在注解类中，有一个字符串类型的变量  `name`。

```java
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.cloud.context.config.annotation.RefreshScope;
import org.springframework.stereotype.Component;

@Component
@RefreshScope
@ConfigurationProperties(prefix="provider.config")
public class ProviderNameConfig {
	private String name = "echo-provider-default-name";

	public String getName() {
		return name;
	}

	public void setName(String name) {
		this.name = name;
	}
}
```



### 2. 使用 @Value 注解

在启动类 `ProviderApplication` 中，使用 `@Value` 注解来标识一个配置变量。下面的示例中 `${test.demo.prop:default}` 中 `test.demo.prop` 是在动态配置下发中使用的 key，value 默认是 `default` 。

```java
// 其他 import 
import org.springframework.web.bind.annotation.RestController;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.RequestMapping;

public class ProviderApplication {
    public static void main(String[] args) {
        SpringApplication.run(ProviderApplication.class, args);
    }	
	
	@Value("${test.demo.prop:defalut}")
	private String propFromValue;
	
	@RequestMapping("/hello/") public String index() {
		String result = "propFromValue: " + propFromValue + "\n";
		return result;
	}				
}
```



## 三、本地验证动态配置功能

在本地验证动态配置功能之前，请确保已经安装并运行本地注册中心。如果您本地的开发机有浏览器，打开 `127.0.0.8:8500`，正常情况下可以看到本地注册中心界面。同时本地已经将 `provider-demo` 和 `consumer-demo` 都运行起来。此时 `provider-demo` 打印的控制台日志中，显示当前 `ProviderNameConfig` 类中 `name` 是默认值。
![](https://main.qcloudimg.com/raw/c731f40300ba0eb2fae8408c457aa332.png)


在本地注册中心的界面中，单击 KEY/VALUE 标签页，输入键值对。key 满足如下规则 `/config/<application-name>/config` 
```
config/provider-demo/data
```

value的格式使用 YAML 格式。

```yaml
provider:
  config:
    name: testname123 # 注意冒号与 testname123 之间的空格
# test.demo.prop: testprop
   
```
单击 `UPDATE` 按钮。`provider-demo` 打印的控制台日志中，`name` 已经变为 testname123，说明应用配置已更新。

![](https://main.qcloudimg.com/raw/06395335b2107417b488c42aa3f44ebb.png)



## 四、通过 TSF 平台下发动态配置

用户也可以通过 TSF 平台来下发动态配置，相较于本地验证配置功能，用户在 TSF 平台上只需要关心配置内容，而无需关心配置存储在配置中心的路径。

前提条件：

1. 已经在 TSF 平台上部署了 `provider-demo` 和 `consumer-demo` 应用。
2. 部署 `provider-demo` 的部署组的日志配置项的日志路径中包含了 `/tsf-demo-logs/provider-demo/root.log`，以确保打印的日志能被采集。



关于如何通过控制台创建及下发更新的配置，参考 [应用配置](https://cloud.tencent.com/document/product/649/15539)。

比如希望修改 `ProviderNameConfig` 类 中的 `providerName` 的值，创建配置时，配置内容填写：

```yaml
provider:
  config:
    name: testname123
```

将配置发布到已部署 `provider-demo` 的部署组上，检查打印的日志中是否 name 的值已更新。如果已更新，说明更新的配置生效。

```
provider-demo -- provider config name: testname123
```
