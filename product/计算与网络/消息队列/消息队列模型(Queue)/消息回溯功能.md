#消息回溯功能说明

CMQ提供『消息回溯』能力：提供类似于kafka的消息回溯能力。当业务成功消费，并删除消息后，使用消息回溯，可重新消费已删除的消息。可指定offset的位置进行调整。这便于核心金融业务，做业务对账、业务系统重试等。




##产品功能说明

![](//mc.qcloudimg.com/static/img/5c1699ab442ad36b7e34a091bbcf089d/image.jpg)

如上图：消息回溯功能阐述：消息的生命周期为蓝色框内的片段。当开启了『消息回溯』能力后，已被消费者已消费，且确认删除的消息，会进入『消息可回溯』的区域，CMQ后端还会保存该信息。但消息超过Queue的消息生命周期时（假设设置为1天），则该消息会随着时间，达到1天后，自动删除，不可追溯。具体产品逻辑如下：

- 开启：若未开启『消息回溯』能力，则消费者已消费，且确认删除的消息，会立即删除。开启该功能时，须指定回溯的『可回溯周期』，『可回溯周期』的范围，必须小余等于消息的生命周期

- 里程碑：根据上一条策略，待开启后，随着消费者的不断消费、删除，『消息可回溯』的区域的消息数量会不断增多

- 关闭：关闭时，该『消息可回溯』部分的消息，立即删除，且不可回溯

- 队列属性：消息回溯是Queue的属性，创建时可设置，修改配置处也可设置。意味着『当指定回溯（rewind）的时间点后，所有消费者都会从那个点，往后消费』

- 计费：开启消息回溯能力后，会额外收取消息的堆积费用（可回溯部分），单位价格与消息堆积的费用共同计算

- 指定回溯时间点：消费者，发起回溯消费，需要指定Queue name，指定具体的回溯时间。且从最远的时间点，往回『回溯』。时间为key，不可逆向消费。 如图中，只能从timeA到timeB/timeC消费，不支持反向消费

- 指定回溯时间范围：时间范围：0-15天。控制台不开启

- 不可指定堆积中的消息回溯：当消息仍在堆积中，未被消费，无法指定某一个具体的位置，进行消费





##可回溯时长

- 最大可回溯时间点 = 当前时间 - 设置的可回溯时长 。消息生产时间在这个值之前的不可回溯，之后的可回溯，如下图所示：

![](//mc.qcloudimg.com/static/img/542c106531dae9c1ac0fe03c3342d096/image.jpg)




##时间轴

- 消息回溯，是按照消息生产的时间，作为排序标准，与被删除的先后无关。如图所示

![](//mc.qcloudimg.com/static/img/7ff35a9529762ca3d832c19e643f782b/image.jpg)


