## 选择push还是pull?

市面上的消息队列，大多是针对 push 模型的设计。现在市面上有很多经典的也比较成熟的 pull 模型的消息队列，如 Kafka、MetaQ 等。腾讯云的 CMQ 支持 Pull、Push 两种方式，而这两种方式的适用场景是什么呢？我们简要分析下 push 和 pull 模型各自存在的利弊。

### 慢消费

**push 模式**
慢消费无疑是 push 模型最大的致命伤，穿成流水线来看，如果消费者的速度比生产者的速度慢很多，势必造成消息在 CMQ 的堆积。假设这些消息都是有用的无法丢弃的，消息就要一直在 CMQ 端保存。当然这还不是最致命的，最致命的是 CMQ 给消费者推送一堆 消费者无法处理的消息，于是消费者不是 reject 就是 error。

**pull 模式**
反观 pull 模式，消费者可以按需消费，不用担心自己已处于高负载无法处理更多消息的情况下，CMQ 还一直推送新的消息过来。CMQ broker 堆积消息也会相对简单，无需记录每一个要发送消息的状态，只需要维护所有消息的队列和偏移量即可。在消费者的消息量有限且消费速度不均匀的情况下，pull 模式比较合适。

### 消息延迟

这是 pull 模式最大的短板。由于主动权在消费方，消费方无法准确地决定何时去拉取最新的消息。如果一次 pull 取到消息了还可以继续去 pull，如果没有 pull 取到消息则需要等待一段时间再重新 pull。

但等待时间就很难判定了。你可能会说，我可以有xx动态拉取时间调整算法，但问题的本质在于，有没有消息到来这件事情决定权不在消费方。也许1分钟内连续来了1000条消息，然后半个小时没有新消息产生，可能你的算法算出下次最有可能到来的时间点是31分钟之后，或者60分钟之后，结果下条消息10分钟后到了，是不是很让人沮丧？

当然也不是说延迟就没有解决方案了，业界较成熟的做法是从短时间开始（不会对 CMQ broker 有太大负担），然后指数级增长等待。比如开始等5ms，然后10ms，然后20ms，然后40ms……直到有消息到来，然后再回到5ms。即使这样，依然存在延迟问题：假设40ms 到80ms 之间的50ms 消息到来，消息就延迟了30ms，而且对于半个小时来一次的消息，这些开销就是白白浪费的。

在腾讯云的 CMQ 里，有一种优化的做法-**长轮询**，来平衡 pull/push 模型各自的缺点。基本方式是：消费者如果尝试拉取失败，不是直接 return，而是把连接挂在那里 wait，服务端如果有新的消息到来，把连接拉起，返回最新消息。
