## 腾讯云容器服务实践之路
### 第一章：起源
自2013年以来，无论从Github的代码活跃度还是从各大厂商对Docker的支持来看，都能发现Docker火爆程度。 基于Docker的容器技术直接造成了整个玩法的改变，令开发、测试、运维工程师都为之兴奋。

腾讯内部对Docker有着广泛的使用，不同的部门对Docker都有不同的应用和玩法。 腾讯云作为腾讯技术开放的窗口，在容器技术方面，自然要提供对应的产品能力给到众多的企业和开发者。

2015年底，腾讯云就已经启动了对容器技术的调研， 仅仅提供Docker并不能够帮用户解决多大问题，我们要提供一整套基于Docker的容器服务。要提供容器服务势必要面临容器调度、编排的选型问题，我们最终在Kubernetes和Swarm以及Mesos三者中选择了Kubernetes，主要基于以下几点考虑：
- **功能**：Kubernetes在三者中功能最为强大， 提供了集群管理、服务管理、容器管理等一整套的功能。Mesos是轻量的调度框架，只提供简单的功能， 需要应用到实际的生产环境任然需要做大量的开发工作;。Swarm具有使用标准Docker接口的优势，但在功能上要比Kubernetes欠缺。
- **稳定性**：Kubernetes 和 Mesos已经有众多跑生产的案例验证，稳定性更高。swarm在这块对比前两者还有所欠缺。
- **社区**：社区这块，kubernetes 从开放源码至今，活跃度持续增长， 到目前为止已经有1300+个contributors, 54000+的commits。 Mesos和Swarm在社区这块远不及kubernetes。社区活跃意味着，系统的持续运营和发展有更为坚强的后盾。
- **可扩展性**：Kubernetes 1.7提供了强大的运行时API聚合能力， 可以让高级用户向集群内添加预先构建的、第三方的或者用户自制的具有Kubernetes风格的API。意味着除了可以提供Kubernetes的基本能力之外，可以更快速结合腾讯云基础能力。 Mesos教轻量，具有搞定可扩展性，但需要投入更多人力支持， Swarm较Kubernetes和Mesos在可扩展性方面还有所欠缺。


### 第二章：发展
选型完成后， 开始着手产品化和研发阶段了。
要将容器服务提供给用户，面临一个至关重要的问题，到底是一个大Kuberentes集群多租户然后提供应用级别的容器服务，还是每个用户多个集群，提供集群级别的容器服务？
腾讯文化一直都是已用户价值为依归，我们拜访和调研了一系列的容器用户，需要运维容器集群用户数远远高于仅希望提供应用级别服务的用户数， 同时提供集群级别的服务，用户可以更灵活的打通原有系统的网络、存储、监控等方案。 用户独占集群隔离性更高、安全性更好。所以我们选择的模式是用户独占集群。

####  2.1 形态 
![Alt text][1]
1. 每个用户可以创建多个集群。
2. 集群有腾讯云的CVM、CLB、CBS、VPC等资源组成。
3. 用户在集群内自由部署业务。 

####  2.2 网络实现
在网络方面我们调研了多种开源的容器网络方案，都难以达到我们的要求，我们希望容器和主机能够直接互访、同时性能要有保证，最终我们结合腾讯云的私有网络实现了CCS的容器网络方案。
![Alt text][2]
1. 容器具备独立 IP， 且在宿主机网段内生效。
2. 性能提升30%， 容器与容器能够直接通信，无NAT转换，容器与宿主机间能够直接通信，无NAT转换。
3. 能完全复用 VPC 功能（Nat网关、VPN网关、专线网关） 。
4. 最终实现，网络性能对比如下图：
![Alt text][3]

####  2.3 存储实现
![Alt text][4]
1. 实现腾讯云快存储CBS的kubernetes插件。
2. CBS跟随容器调度。
3. 完全复用CBS功能 - 多副本、快照、高效、灵活。
4. 除CBS插件之外，我们正在进行腾讯云的对象存储COS、文件存储CFS的插件适配。
####  2.4 监控实现
![Alt text][5]
1. 每个主机上部署CAdvisor和监控的Agent，监控指标上报到腾讯云监控系统。
2. 监控跟腾讯云的云监控结合，复用云监控的秒级监控、告警能力。

### 第三章：转折
![Alt text][6]
随着功能的上线和持续开放，一个问题开始困扰着我们 —— 改Kubernetes的源码来做更深的定制化？还是不动kubernetes源码，在这基础上做适配和上层功能?
虽然如果基于某个Kubernetes版本定制出腾讯云的容器服务会更容器做灵活的功能和适配，但同样意味着我们无法跟上kubernetes社区快速的更新迭代。社区的力量是巨大的，选择开放将用于社区1300+的contributors的坚强后盾。同样选择开源也会造成有些特性或功能无法满足到用户的述求，但我们会将这些用户的述求回馈社区，让社区也能看到腾讯云容器服务的用户对kubernetes关注，为社区奉献腾讯云容器团队的一份力量。
毫无疑问，我们选择了拥抱开源，源于社区，回馈社区。


### 第四章：进阶
选择了开放的路线，同样给我们带来了挑战， 我们走完全开放的路线，兼容原生kubernetes， 那么问题来了—— 容器服务CCS对比自建Kubernetes集群有什么优势？为什么要选择腾讯云容器服务CCS？
以下两点可以回答这个问题, CCS提供`稳定的运行时`和`kubernetes上层的进阶能力`。
####  4.1 稳定的运行时：
1. 如果您不关心底层实现，只需使用封装好的控制台，快速入门和使用容器服务
2. 如果您需要灵活定制、高级能力，可以直接使用Kuebernetes API， 我们来维护Kubernetes 和 Docker的 Bug， 您只需要关注业务的部署和实现，容器团队来提供稳定的运行时。
####  4.2 进阶能力：
**应用市场**：
- 一键式  创建业务模块+常用开源服务
- 提供应用模版+配置：不同用户 可以 修改配置文件，一键式搭建一个完整应用
- 开放应用市场：一键创建常见的开源服务（elk,zabix, prometheus,influxdb, kafka）

**Devops**：
- 打通开发、测试、运维流程 
- CI/CD 服务 打通 开发、测试及运维流程：海外构建加速
- 提供更多devops相关服务：代码托管、pipeline等……

**结合腾讯已有服务，提供完善解决方案**
- 监控解决方案
- 图像识别解决方案
- 大数据解决方案

### 第五章：总述
最好一张图总结下腾讯云容器服务：
![Alt text][7]
欢迎大家使用腾讯云容器服务，前往[腾讯云容器服务控制台](https://console.qcloud.com/ccs)
扫描下发二维码加入腾讯云容器服务交流群

`待补充二维码`

附录：容器服务系列文章
1. [基于 kubernetes 的应用编排实践](https://www.qcloud.com/community/article/563924)
2. [Kubernetes Scheduler 调度详解](https://www.qcloud.com/community/article/339740)
3. [kubernetes 中 kafka 和 zookeeper 有状态集群服务部署实践 (一)](https://www.qcloud.com/community/article/198250)
4. [kubernetes 中 kafka 和 zookeeper 有状态集群服务部署实践 (二)](https://www.qcloud.com/community/article/983969)
5. [腾讯云容器服务中对容器实例日志设置定期清理和回卷](https://www.qcloud.com/community/article/579587)
6. [腾讯云容器服务上添加外部 DNS 服务器](https://www.qcloud.com/community/article/408959)
7. [腾讯云容器服务搭建 ELK 日志系统](https://www.qcloud.com/community/article/751647)
8. [Kubernetes 中 Pod 弹性伸缩详解与使用](https://www.qcloud.com/community/article/315753)
9. [腾讯云容器服务构建简单web service](https://www.qcloud.com/community/article/223421)
10. [腾讯云容器服务监控体系详解](https://www.qcloud.com/community/article/541138)
11. [华尔街见闻：基于腾讯云容器服务的微服务架构实践](https://www.qcloud.com/community/article/314717)
12. [Kubernetes 资源分配之 Request 和 Limit 解析](https://www.qcloud.com/community/article/905142)
13. [Kubenerters中多种服务访问方式以及相应的安全组设置在腾讯云的落地实践](https://www.qcloud.com/community/article/711355)
14. [容器健康检查详解](https://www.qcloud.com/community/article/681252001482806768)
15. [腾讯云容器服务的滚动升级使用简介](https://www.qcloud.com/community/article/216046001482723263)


[1]:https://mc.qcloudimg.com/static/img/f565a4f28cb2cf338dded17ba20c9931/1504597813152.png
[2]:https://mc.qcloudimg.com/static/img/430411781d30cdcd9e1ace45c4efe678/1504585025450.png
[3]:https://mc.qcloudimg.com/static/img/2e053ab30e0da396f184c64cf4a2db10/1504584926141.png
[4]:https://mc.qcloudimg.com/static/img/3134659f4b49c5e595f118600c639d97/1504584977566.png
[5]:https://mc.qcloudimg.com/static/img/dabcdeddd2457177950ab93ad45c847b/1504585212995.png
[6]:https://mc.qcloudimg.com/static/img/9f035a6f9d714821fc9f31a8d2d4653a/1504595136462.png
[7]:https://mc.qcloudimg.com/static/img/b7aeda0a875310261900d2ab4d262cc4/1504584590291.png
