
## 背景介绍
绝大多数客户拿到小直播代码之后，第一件事情就是替换账号系统，毕竟自己APP的账号系统是不能随便动的。

在小直播的设计之初我们就考虑到了这一点，所以跟直播录播相关的功能设计均没有强依赖账号体系和用户资料，目的就是能让您快速完成账号体系的替换，这里大概有如下几个模块要调整：

## 聊天室
小直播使用IM消息模块实现了直播间聊天室的如下几个功能：
- 普通的文本消息
- 弹幕消息
- 某某人的进出消息
- 点赞消息

聊天室本身是一种比较开放的聊天模式，进入直播间就可以发言，退出直播间后就不需要再收到相关消息。如果您只需要实现上述四个功能，只需将小直播原来的登录逻辑屏蔽掉并改用访客模式登录即可。

**访客模式** 是腾讯云IM通讯模块的运行模式之一，该模式下，腾讯云IM消息后台会使用一些匿名账号进行通讯，这些匿名账号不需要用户去注册，而是腾讯云后台自动分配，APP只要本地保留就能一直使用。

**匿名账号**存储在您的腾讯云托管账号系统中，故本质来说，这些匿名账号依然是腾讯云在替您维护，访客模式只是由您告诉我们您不是特别关心这些账号是什么，只是借用这些“傀儡账号”发消息而已。

- **iOS平台**
> 1. 屏蔽掉小直播里自带的用户名密码登录逻辑。
> 2. 直接使用 TLSHelper.h 里的 TLSGuestLogin 函数完成访客模式登录，之后就可以收发消息了。

- **Android平台**
> 1. 屏蔽掉小直播里自带的用户名密码登录逻辑：TCLoginActivity##userNameLoginViewInit
> 2. 直接调用TCLoginMgr的guestLogin()函数完成访客模式登录，之后就可以收发消息了。


## 用户资料
这里说的用户资料都是主播的资料（比如昵称、头像），也就是APP当前用户的资料，观众这一方看到的各个主播的信息是在拉取直播间列表的时候就已经取到了。

小直播默认使用了腾讯云的托管账号服务，故其默认的用户资料是存储于腾讯云托管账号资料系统中的，所以替换账号后，用户资料部分自然也要相应的调整。

- **iOS平台**
  + **屏蔽旧逻辑**：
  屏蔽自动从腾讯服务器拉取用户资料的逻辑，小直播在登录成功后，会自动从服务器拉取用户资料，如果资料存在您自己的服务器，这个逻辑需要屏蔽，做法是删除TCIMPlatform.m中的initUserInfoMgr的调用：
   ![](//mc.qcloudimg.com/static/img/e828941a200e18068fa470fc75f7cd29/image.png)
  + **对接新资料**：
  推荐的做法是调用TCUserInfoMgr中的setUserProfile接口设置新的用户资料（如昵称、头像、封面等），小直播在用到用户资料时，将会从用户资料管理类TCUserInfoMgr中获取，从而最小化您的适配工作：
  ![](//mc.qcloudimg.com/static/img/e78f80670d85478432e4fe5d932d2430/image.jpg)

- **Android平台**
  小直播默认的逻辑是在登录完成后，调用TCUserInfoMgr中的queryUserInfo()，改函数的作用是从腾讯云账号系统中拉取用户资料并将其设置到mUserInfo成员变量中，故修改该函数即为最简单和快速的适配方案：
  ![](//mc.qcloudimg.com/static/img/3cc88fb62c6b7fac4215c034806f8d06/image.jpg)


## 群发消息
小直播发送各类消息（如文本消息、弹幕消息、点赞消息、成员进退消息）等，都统一采用了IM SDK的文本消息类型，消息体采用json格式。

一条群发消息内含发送者的资料信息（主要是id、昵称、头像），该信息来源于 **TCUserInfoMgr** 模块，小直播会从TCUserInfoMgr获取当前用户的资料信息并拼接到json格式的消息体中。

当然您也可以自主定制这里的逻辑，相关代码位于TCMsgHandler（iOS）和TCChatRoomMgr（Android）中：
![](//mc.qcloudimg.com/static/img/ae64a2ccf99503803fd7eb88f909d6a5/image.jpg)


## IM模块的账号绑定
接下来说一点 <font color='red'>“超纲”</font>（小直播目前的功能不涉及这个部分，您也无需一定要了解它）的话题：**账号绑定**。

看完前面的部分您会发现，不管是用TLS登录还是访客登录，IM通信模块的后面都是一个托管的账号数据库，账号的注册和分配都是腾讯云处理的。

您可能会想：`是否可以让消息的发送人和接收人都实打实的是我自己账号数据库里的id呢`，当然是可以的，不过为了实现这一点，您需要完成如下几项工作:
> 1. 在腾讯云通讯[管理控制台](https://console.qcloud.com/avc)，将集成模式改成**独立模式**，并下载签名用的公私钥。
>
> 2. 手机App的登录逻辑依旧按您原来的流程，即ID + PASSWORD到您的登录服务器进行验证。如果登录成了，您的登录服务器需要额外下发一个UserSig签名，该签名使用步骤1中下载到的私钥对相应的ID进行签发。
>
> 3. 手机App在拿到ID和UserSig以后，就可以调用IM SDK的imLogin(ID, UserSig)接口进行登录了，腾讯云后台会使用步骤一中相应的公钥进行解密，从而验证ID是否得到了您的登录服务器的认可。

以上步骤的示意图如下：
![](//mc.qcloudimg.com/static/img/1e541b2931d0cb8fb1815f26aa8fb493/image.png)

这里貌似有点复杂，实际上它背后的原理还是很简单的，我们打个更形象的比方：
> 1. 某个ID（比如“花仙子”）在您的App上登录，她使用了之前在您这里注册的ID和密码。
>
> 2. 如果您验证通过了，就开给她一个放行条，上面写着“<font color='blue'>'花仙子'美女良民的干活，到你腾讯的地盘，你得给伺候好了...</font>”，为了确保这个放行条不被伪造，您还在上面签了字。
>
> 3. 我们看了您的放行条以后，确认签字为您本人亲笔所签，自然会提供相应的服务。

对，以上就是独立模式其背后的运行原理。

