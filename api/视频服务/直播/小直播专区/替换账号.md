
## 背景介绍
绝大多数客户拿到小直播代码之后，第一件事情就是替换账号系统，毕竟自己APP的账号系统是不能随便动的。

在小直播的设计之初我们就考虑到了这一点，所以跟直播录播相关的功能设计均没有强依赖账号体系和用户资料，目的就是能让您快速完成账号体系的替换，这里大概有如下几个模块要调整：

## 直播间聊天室
小直播使用IM消息模块实现了直播间聊天室的如下几个功能：
- 普通文本消息：包括发送者的昵称以及消息本身。
- 弹幕消息：本质也是文本消息，只是消息的展示方式会更显花哨。
- 点赞消息：当一位观众为主播点赞时，要保证其他观众也能看到
- 系统通知，比如“XXX已加入房间”或者“主播已离开”等等。

您在把小直播里的TLS（Tencent Login Service）普通登录替换成自己的账号体系后，就不能再继续采用原来的方式使用IM消息模块了，而是要改用**访客模式**。

**访客模式** 是腾讯云IM通讯模块的运行模式之一，该模式下，腾讯云会为每个App用户生成一个“**访客账号**“，该账号只会用来收发消息，可以理解为一个“傀儡账号”。消息发送者的真实用户信息（昵称、头像等等）不跟该账号绑定，而是跟着消息体一起发出去。

具体的**切换方法**如下：

- **step1: 确认集成模式**
> 确保腾讯[云通讯控制台](https://console.qcloud.com/avc)中的集成模式为**托管模式**，这样能让腾讯云为访客模式的访客账号提供后台支持。
> ![](//mc.qcloudimg.com/static/img/d52ac3662d5310673a5d6c6a78f50da4/image.png)

- **step2: 屏蔽TLS常规登录逻辑**
> iOS平台：TCLoginViewController##viewDidLoad 实现了小直播自带的用户名密码“自动登录”逻辑。
> Android平台：TCLoginActivity##onCreate 里对 userNameLoginViewInit 函数的调用相当于是一种“自动登录”。

- **step3: 启用访客模式**
> iOS平台：位于TCIMPlatform.h 中的 guestLogin。
> Android平台：位于TCLoginMgr.java 中的 guestLogin 函数。

## 用户资料
这里说的用户资料都是主播的资料（比如昵称、头像），也就是APP当前用户的资料，观众这一方看到的各个主播的信息是在拉取直播间列表的时候就已经取到了。

小直播默认使用了腾讯云的托管账号服务，故其默认的用户资料是存储于腾讯云托管账号资料系统中的，所以替换账号后，用户资料部分自然也要相应的调整。

- **iOS平台**
  + **屏蔽旧逻辑**：
  屏蔽自动从腾讯服务器拉取用户资料的逻辑，小直播在登录成功后，会自动从服务器拉取用户资料，如果资料存在您自己的服务器，这个逻辑需要屏蔽，做法是删除TCIMPlatform.m中的initUserInfoMgr的调用：
   ![](//mc.qcloudimg.com/static/img/e828941a200e18068fa470fc75f7cd29/image.png)
  + **对接新资料**：
  推荐的做法是调用TCUserInfoMgr中的setUserProfile接口设置新的用户资料（如昵称、头像、封面等），小直播在用到用户资料时，将会从用户资料管理类TCUserInfoMgr中获取，从而最小化您的适配工作：
  ![](//mc.qcloudimg.com/static/img/e78f80670d85478432e4fe5d932d2430/image.jpg)

- **Android平台**
  小直播默认的逻辑是在登录完成后，调用TCUserInfoMgr中的queryUserInfo()，改函数的作用是从腾讯云账号系统中拉取用户资料并将其设置到mUserInfo成员变量中，故修改该函数即为最简单和快速的适配方案：
  ![](//mc.qcloudimg.com/static/img/3cc88fb62c6b7fac4215c034806f8d06/image.jpg)


## 定制群发消息
小直播发送各类消息（如文本消息、弹幕消息、点赞消息、成员进退消息）等，都统一采用了IM SDK的文本消息类型，消息体采用json格式。

一条群发消息内含三类关键信息：
- **消息类型**
我们在小直播中定义的消息类型一共有 5 种，它们分别是：

| 消息类型 | 数字 | 含义 |
|:---------|---------|---------|
| AVIMCMD_Custom_Text | 1 | 文本消息 |
| AVIMCMD_Custom_EnterLive | 2 | 用户加入直播 |
| AVIMCMD_Custom_ExitLive | 3 | 用户退出直播 |
| AVIMCMD_Custom_Like | 4 | 点赞消息 |
| AVIMCMD_Custom_Danmaku | 5 | 弹幕消息 |

- **发送者信息**
用户账号ID、昵称、头像等，该信息来源于 **TCUserInfoMgr** 模块，小直播会从TCUserInfoMgr获取当前用户的资料信息并拼接到json格式的消息体中。

- **消息内容**
政府对直播的规范性问题抓的比较紧，所以消息本身的敏感字过滤功能很关键，腾讯云通讯服务本身有脏字过滤功能，这里不用有后顾之忧。

当然您也可以自主定制这里的逻辑，相关代码位于TCMsgHandler（iOS）和TCChatRoomMgr（Android）中：
![](//mc.qcloudimg.com/static/img/ae64a2ccf99503803fd7eb88f909d6a5/image.jpg)


## IM 账号绑定
接下来说一点 <font color='red'>“超纲”</font>的话题：**账号绑定**，小直播目前的功能不涉及这个部分，您也无需一定要了解它。

访客模式在接入方便性上很有优势，一个GuestLogin函数就能解决问题，但您可能会想：“访客登录毕竟是使用的是腾讯云的访客账号，虽然只是用来收发消息的“傀儡账号”，但也感觉怪怪的，是否可以让消息的收发人都实打实的是我自己App的账号呢？”

当然是可以的，不过为了实现这一点，您需要完成如下几项工作:
> 1. 在腾讯云通讯[管理控制台](https://console.qcloud.com/avc)，将集成模式改成**独立模式**，并下载签名用的公私钥。
>
> 2. 手机App的登录逻辑依旧按您原来的流程，即ID + PASSWORD到您的登录服务器进行验证。如果登录成了，您的登录服务器需要额外下发一个UserSig签名，该签名使用步骤1中下载到的私钥对相应的ID进行签发。
>
> 3. 手机App在拿到ID和UserSig以后，就可以调用IM SDK的imLogin(ID, UserSig)接口进行登录了，腾讯云后台会使用步骤一中相应的公钥进行解密，从而验证ID是否得到了您的登录服务器的认可。

以上步骤的示意图如下：
![](//mc.qcloudimg.com/static/img/1e541b2931d0cb8fb1815f26aa8fb493/image.png)

这里貌似有点复杂，实际上它背后的原理还是很简单的，我们打个更形象的比方：
> 1. 某个ID（比如“花仙子”）在您的App上登录，她使用了之前在您这里注册的ID和密码。
>
> 2. 如果您验证通过了，就开给她一个放行条，上面写着“<font color='blue'>'花仙子'美女良民的干活，到你腾讯的地盘，你得给伺候好了...</font>”，为了确保这个放行条不被伪造，您还在上面签了字。
>
> 3. 我们看了您的放行条以后，确认签字为您本人亲笔所签，自然会提供相应的服务。

对，以上就是独立模式其背后的运行原理。

