## 5.1 功能简介
本节要介绍的内容是在主播和观众之间的IM消息解决方案，它主要用于实现如下几个功能点：
（1）普通文本消息
（2）弹幕消息
（3）点赞消息
（4）系统通知，比如“XXX已加入房间”或者“主播已离开”等等。
![](//mc.qcloudimg.com/static/img/d77b0df57a0aa4b102d13868bbdc4cd4/image.png)

[**腾讯云通讯**](https://www.qcloud.com/product/im.html) 服务提供了一套完整的成体系的即时通讯解决方案，本节我们将介绍如何使用腾讯云IM通讯服务实现上述的几个功能点。

## 5.2 开通服务
在使用腾讯云通讯服务之前，首先要将这个服务开通，可以按照如下步骤操作：

进入[云通讯管理控制台](https://console.qcloud.com/avc)，如果还没有服务，直接点击**直接开通云通讯**按钮即可。新认证的腾讯云账号，云通讯的应用列表是空的，如下图：
![](//mc.qcloudimg.com/static/img/c033ddba671a514c7b160e1c99a08b55/image.png)

点击**创建应用接入**按钮创建一个新的应用接入，即您要接入腾讯云IM通讯服务的App的名字，我们的测试应用名称叫做“小直播演示”，如下图所示：
![](//mc.qcloudimg.com/static/img/897bff65af6202322a434b6fa3f8a0bd/image.png)

点击确定按钮，之后就可以在应用列表中看到刚刚添加的项目了，如下图所示：
![](//mc.qcloudimg.com/static/img/1c1cb2c2fa4c6f0dc7be06bf8329dee3/image.png)

上图的列表中，SDKAPPID 这一列显示的是腾讯云通讯业务ID，这个ID在对接各平台版本的IM SDK时都会用到，右侧有一个**应用配置按钮**，点击这里进入下一步的配置工作，如下图所示。
![](//mc.qcloudimg.com/static/img/d52ac3662d5310673a5d6c6a78f50da4/image.png)

此处的配置项比较多，但大部分都不重要，而且后面也都可以随时调整，比如：
- 账号名称您可以随便填写，注意不要用特殊字符；
- 验证方式里目前有且仅有“系统生成公钥”是可选项；
- 账号管理员名称是一个可以方便调试用的id，如果您是工程师，直接填写自己后面用的账号id就可以了。
- 验证短信签名就是短信文本的前缀，填写App的名称就可以了。

这里需要您特别关注的一个配置项就是 **集成模式** 了。

## 5.3 集成模式
“集成模式”这四个字所关注的是IM消息收发方身份（账号）的问题，不管是 1 v 1 的单发消息，还是 1 v N 的群发消息，消息的发送者和接受者身份（账号）必须要是确定的，否则消息的发送接收无从谈起。

考虑到各种各样客户的需求，腾讯云的提供了两种解决方案，**访客（托管）模式**和**独立模式**。

| 集成模式 | 适用场景 | 对接难度 | 原理分析 |
|------------|-------------|-------------| -----------|
| 访客（托管）模式 | 对安全要求不高的场景，允许App用户都可以发言的直播间聊天室场景。 | 采用guestLogin模式登录 IM SDK即可，对接成本极低。 | 这种模式的核心目标是降低对接成本，让您能够不对接账号系统的情况下就能使用IM服务，腾讯云会为每个App用户生成一个<font color='blue'>“访客账号“</font>，该账号只会用来收发消息。|
| 独立模式 | 对安全要求非常高的客户，比如仅允许自己App的注册用户才可以发IM消息。 | 需要使用UserSig安全签名，极高要求的情况下需要导入用户id账号到腾讯云，对接成本比较高。| 独立模式的核心目标是追求较高的安全性，它致力于让IM服务集成您已有的账号系统，在您的登录服务器确认App用户身份后派发签名，腾讯云通过检查签名合法性确认是否允许收发消息。|

## 5.4 访客（托管）模式
在 **5.2 **中集成模式选项里选择**托管模式**，您就可以在IM SDK里使用**访客模式**登录腾讯云通讯服务了，具体做法如下：

### 5.4.1 iOS 平台
1. 查询SDKAPPID ，ID的获取参考文章上半部分的**5.2**。

2. 调用 TLSHelper （TLS 的全称是 “Tencent Login Service” ，是腾讯云 IM SDK 的核心组件）里面的 TLSGuestLogin 函数，它会到腾讯云后台请求一个访客账号，如果第一步骤中的 SDKAPPID 没有设置错误，并且手机可以接入互联网，那么您会成功拿到一个 TLSUserInfo 对象，TLSUserInfo.identifier 即为访客账号的ID。

3. 使用 TLSHelper 的 getTLSUserSig 函数可以为该 identifier 生成一个合法的 UserSig 签名。

4. 最后，使用刚刚拿到的 identifier 和 UserSig 可以构造一个 TIMLoginParam 对象，之后使用 TIMManager 的 login 函数即可完成 IM SDK 的登录流程了。

```objective-c
// 示例代码 1： 调用TLS（Tencent Login Server）的访客模式登录
- (void)guestLogin:(UIButton *)button {
    TLSUserInfo *info = [[TLSHelper getInstance] getGuestIdentifier];
    int ret = [[TLSHelper getInstance] TLSGuestLogin:self];
    if (ret == 0) {
           // 登录中，转个登录中的菊花吧
    } else {
           // TLSHelper 出错了， 请检查 IMSDK_APPID 是不是搞错了
    }
}

// 示例代码 2： 在TLS（Tencent Login Server）登录成功后调用IM SDK 登录
- (void)OnGuestLoginSuccess:(TLSUserInfo *)userInfo {
    TIMLoginParam *loginParam = [[TIMLoginParam alloc] init];
    loginParam.appidAt3rd = @"88888888"; // 填写您的SDKAPPID
    loginParam.sdkAppId = 88888888       // 填写您的SDKAPPID
    loginParam.accountType = @"0";
    loginParam.identifier = userInfo.identifier;
    loginParam.userSig = [[TLSHelper getInstance] getTLSUserSig:userInfo.identifier];

    [[TIMManager sharedInstance] login:loginParam succ:^{
		     // OK, 登录成功，后面就可以发消息了！
    } fail:^(int code, NSString *msg) {
        // im sdk 登录失败，请检查 IMSDK_APPID 是不是搞错了
    }];
}
```

### 5.4.2 Android 平台
1. 查询SDKAPPID ，ID的获取参考文章上半部分的**5.2**。
    
2. 调用TLS（Tencent Login Service）的 TLSGuestLogin 函数完成访客登录，此时它会到腾讯云后台请求一个访客账号，如果第一步骤中的SDKAPPID 没有设置错误，并且手机可以接入互联网，那么您会成功拿到一个 TLSUserInfo 对象，TLSUserInfo.identifier 即为访客账号的ID。

3. 使用TLS的 getUserSig 函数可以为该 identifier 生成一个合法的 UserSig 签名。

4. 最后，使用刚刚拿到的 identifier 和 UserSig 调用 TIMManager 的 login 函数即可完成 IM SDK 的登录流程了。

```java
// 示例代码： Android 平台下实现IM SDK 的访客登录
public void guestLogin() {
        //调用TLS（Tencent Login Server）的访客登录模式
        mTLSLoginHelper.TLSGuestLogin(new TLSGuestLoginListener() {
            @Override
            public void OnGuestLoginSuccess(TLSUserInfo tlsUserInfo) {

                //设置SDKAPPID
                TIMUser user = new TIMUser();
                user.setAccountType(String.valueOf(TCConstants.IMSDK_ACCOUNT_TYPE));
                user.setAppIdAt3rd(String.valueOf(TCConstants.IMSDK_APPID));
                user.setIdentifier(tlsUserInfo.identifier);
                String userSig = mTLSLoginHelper.getUserSig(identifier);

                //发起 IM SDK 登录操作，登录成功后就可以发消息了
                TIMManager.getInstance().login(TCConstants.IMSDK_APPID, user, userSig, new TIMCallBack() {
                    @Override
                    public void onSuccess() {
                        // OK, 登录成功，后面就可以发消息了！
                    }
										@Override
                    public void onError(int i, String s) {
                        // im sdk 登录失败，请检查 IMSDK_APPID 是不是搞错了
                    }
                });
            }
        });
    }
```

## 5.5 独立模式
独立模式的对接步骤要比访客模式繁琐很多，毕竟它要面对的问题是安全信任问题，下图是对整个过程的一个阐释：
![](//mc.qcloudimg.com/static/img/1e541b2931d0cb8fb1815f26aa8fb493/image.png)


1. 在腾讯云通讯[管理控制台](https://console.qcloud.com/avc)，将集成模式改成**独立模式**，并下载签名用的公私钥。

2. 手机App的登录逻辑依旧按您原来的流程，即ID + PASSWORD到您的登录服务器进行验证。如果登录成了，您的登录服务器需要额外下发一个UserSig签名，该签名使用步骤1中下载到的私钥对相应的ID进行签发。

3. 手机App在拿到ID和UserSig以后，就可以调用IM SDK的imLogin(ID, UserSig)接口进行登录了，腾讯云后台会使用步骤一中相应的公钥进行解密，从而验证ID是否得到了您的登录服务器的认可。


> **<font color='black'> 现实一点的例子 ！</font>**
> 
>  如果您对上面的步骤不太理解，下面这个更现实一点的故事希望能够帮助到您：
>  
> 1. 某个女性用户在您的App上登录了，她使用了之前在您这里注册的ID和登录口令，ID叫做 “花仙子”。
>
> 2. 您这边在拿到ID和口令后立刻进行了验证，并且确认她可以登录App。于此同时，您还开给她一张**放行条**，上面写着“<font color='blue'> '花仙子' 是良民的干活，到你腾讯的地盘，你可得伺候好了，不要亏待她...</font>”，为了确保这个放行条不被伪造，您还在上面用正楷签了名。
>
> 3. 腾讯云在看了您的放行条以后，确认签字为您本人亲笔所签，自然会提供相应的服务。
>
> 对，以上就是独立模式其背后的运行原理，而故事里放行条上的签名就是UserSig。

