新混流系统
===
1、接口描述
---
###1.1、通过http协议请求接口cgi
<br  />
``` 
http://fcgi.video.qcloud.com/common_access
``` 
###1.2、通过URI传递鉴权参数
<br  />
```
http://fcgi.video.qcloud.com/common_access?cmd=appid&interface=Mix_StreamV2&t=t&sign=sign
```
参数说明:
**cmd** : 填写直播APPID，用于区分不同客户的身份
**interface** : Mix_Stream，固定值
**t** : UNIX时间戳，即从1970年1月1日（UTC/GMT的午夜）开始所经过的秒数；这个字段表示的是请求过期时间，请您在获取当前时间（秒）的基础上加60秒偏移
**sign** :  sign = MD5(key + t) ，即把加密key 和 t 进行字符串拼接后，计算一下md5值。这里的key是您在腾讯云直播管理控制台中设置的API鉴权key
<br  />
**举例说明安全签名sign的计算方法**
<br  />
```
key = "40328529ca4381a80c6ecf2e6aa57438"                    //API鉴权key 
t = 1490858347                                              //t 过期时间
key + t = "40328529ca4381a80c6ecf2e6aa574381490858347"      //key 和 t 进行字符串拼接
sign = MD5（key + t） = "7f29ed83c61b77de1b0d66936fd4fd44"   //对拼接后的字符串计算MD5
```
<br  />
**HTTP请求说明**
```
POST /common_access&interface=mix_streamv2.start_mix_stream_advanced&sign=xxxxxxxxx&cmd=appid HTTP/1.0
Content-Length: 741
...
```
###1.3、通过POST方法传递混流body
<br  />
**示例**
<br  />
```
{
    "timestamp":int(time.time()),           # UNIX时间戳，即从1970年1月1日（UTC/GMT的午夜）开始所经过的秒数
    "eventId":int(time.time()),             # 取随机数即可，标识一次网络请求
    "interface":
    {
        "interfaceName":"Mix_StreamV2",        # 固定取值"Mix_StreamV2"
        "para":
        {
            "app_id": appid,                # 填写直播APPID
            "interface": "mix_streamv2.start_mix_stream_advanced",  # 固定取值"mix_streamv2.start_mix_stream_advanced"
            "mix_stream_session_id" : "5000_enson",                # 填大主播的流ID
            "output_stream_id": "5000_enson11",                      # 填大主播的流ID
            "output_stream_type": 0,                                          # 填输出流类型
            "input_stream_list":
            [
                # 大主播：背景画面
                {
                    "input_stream_id":"5000_enson11",    # 流ID
                    "layout_params":
                    {   
                        "image_layer": 1                # 图层标识号：大主播填 1 ;  小主播按照顺序填写2、3、4、5、6
                    }   
                },
                # 小主播1
                {
                    "input_stream_id":"5000_enson22",    # 流ID
                    "layout_params":
                    {   
                        "image_layer": 2,               # 图层标识号
                        "image_width": 160,             # 小主播画面宽度
                        "image_height": 240,            # 小主播画面高度
                        "location_x": 380,              # x偏移：相对于大主播背景画面左上角的横向偏移
                        "location_y": 630               # y偏移：相对于大主播背景画面左上角的纵向偏移
                    }   
                 },
                # 小主播2
                 {
                     "input_stream_id":"5000_enson33",
                     "layout_params":
                     {
                         "image_layer": 3,
                         "image_width": 160,
                         "image_height": 240,
                         "location_x": 380,
                         "location_y": 390
                     }
                 },
                # 小主播3
                 {
                     "input_stream_id":"5000_enson44",
                     "layout_params":
                     {
                         "image_layer": 4,
                         "image_width": 160,
                         "image_height": 240,
                         "location_x": 380,
                         "location_y": 150
                     }
                 }
            ]
        }
    }
}
```
**具体参数说明**
<br  />
**timestamp** : **int**  取当前时间（秒）即可，**必填项** 
**eventId** : **int**  取随机值即可，标识一次网络请求，**必填项** 
**interfaceName** ：**string**   Mix_StreamV2，固定值，**必填项** 
**app_id** ： **int**  直播APPID，**必填项** 
**interface** : **string**  填写mix_streamv2.start_mix_stream_advanced，固定值，**必填项** 
**mix_stream_session_id** ：**string**  填写80字节以内，仅含字母、数字以及下划线的字符串，**必填项** 
**output_stream_id** ：**string**  指定输出流ID，**必填项** 
**output_stream_type** : **int**  指定输出流类型。当输出流为输入流list中的一条时，填写0；当输出流为一条新的流，并非输入流list中的流时，该值为1。不填默认为0。**选填项** 
**mix_stream_template_id** ： **int**  输入模版ID。目前两输入源支持10、20、30、40；三输入源支持310、390、391；四输入源支持410；五输入源支持510、590；六输入源支持610。不填默认为0，**选填项** 
**input_stream_id** : **string**   指定输入流ID， **必填项**  
**image_layer** ： **int**  图层标识号，目前支持1-6。**必填项**  
**input_type**  :  **int** 输入源标识，0表示输入源为流，3表示输入源为画布。**选填项** 
**image_width**  :  **int** 输入画面的宽度。建议在0-3000以内。**选填项** 
**image_height**  :  **int** 输入画面的高度。建议在0-3000以内。  **选填项** 
**location_x**  :  **int** x偏移：相对于大主播背景画面左上角的横向偏移。  **选填项** 
**location_y**  :  **int** y偏移：相对于大主播背景画面左上角的纵向偏移。  **选填项**  
**color**  :  **string** 当输入源为画布时，必须输入颜色。**选填项** 
**常用的颜色说明**：
红色：0xcc0033
黄色：0xcc9900
绿色：0xcccc33
蓝色：0x99CCFF
黑色：0x000000
白色：0xFFFFFF
灰色：0x999999
<br  />
###1.4、接口返回
<br  />
```
{"code":0, "message":"Success!", "timestamp":1490079362}
```
<br  />
**参数说明**
<br  />
**code**  :  返回错误码，0表示成功，其他表示失败
**message**  :  返回错误信息
**timestamp**  :  返回时间
<br  />
**常见错误码说明**：
<br  />
-27、-29 ： 表示当前输入流查询失败
-21 ： 表示当前输入的小画面位置参数非法，小画面越出主画面边界
-9 、-103： 对当前sessionid下的输出流未取消混流操作，同时用该sessionid去操作其他的输出流。
其他 ： 其他错误，请联系我们。
<br  />
###1.5、取消混流的方法
<br  />
```
{
    "timestamp":int(time.time()),           # UNIX时间戳，即从1970年1月1日（UTC/GMT的午夜）开始所经过的秒数
    "eventId":int(time.time()),             # 混流事件ID，取时间戳即可，后台使用
    "interface":
    {
        "interfaceName":"Mix_StreamV2",        # 固定取值"Mix_StreamV2"
        "para":
        {
            "app_id": appid,                # 填写直播APPID
            "interface": "mix_streamv2.start_mix_stream_advanced",  # 固定取值"mix_streamv2.start_mix_stream_advanced"
            "mix_stream_session_id" : "5000_enson",                # 填大主播的流ID
            "output_stream_id": "5000_enson11",                      # 填大主播的流ID
            "input_stream_list":
            [
                # 大主播：背景画面
                {
                    "input_stream_id":"5000_enson11",    # 流ID
                    "layout_params":
                    {   
                        "image_layer": 1                # 图层标识号：大主播填 1 ;  小主播按照顺序填写2、3、4
                    }   
                }
            ]
         }
    }
}  
```
<br  />
**说明** ：使用当前sessionid操作当前输入流即可取消混流，半分钟后即可使用该sessionid操作其他输出流
<br  />
2、使用场景及部分特殊处理说明
---
###2.1、常用模版说明
<br  />
常用的模版有10、20、30、40、310、410、510、610。使用这八种模版时，输入流不需要填写位置和长宽参数,，**为原始画面的等比例缩放**。只需要传入模版id即可。
<br  />
**模版10**效果图：

![图片描述](/tfl/captures/2017-05/tapd_10149631_base64_1494312302_93.png)

<br  />
**模版20**效果图：

![图片描述](/tfl/captures/2017-05/tapd_10149631_base64_1494312345_50.png)

<br  />
**模版30**效果图：

![图片描述](/tfl/captures/2017-05/tapd_10149631_base64_1494312376_21.png)

<br  />
**模版40**效果图：

![图片描述](/tfl/captures/2017-05/tapd_10149631_base64_1494312405_32.png)

<br  />
**模版310**效果图：

![图片描述](/tfl/captures/2017-05/tapd_10149631_base64_1494312439_95.png)
<br  />
**模版410**效果图：

![图片描述](/tfl/captures/2017-05/tapd_10149631_base64_1494312545_77.png)
<br  />
**模版510**效果图：

![图片描述](/tfl/captures/2017-05/tapd_10149631_base64_1494312579_73.png)
<br  />
**模版610**效果图：

![图片描述](/tfl/captures/2017-05/tapd_10149631_base64_1494312614_6.png)
<br  />
###2.2、特殊模版的说明
<br  />
为了便于部分用户的同屏对比需求，目前定制了三个特殊的模版390、391以及590
<br  />
**模版390**效果图：

![图片描述](/tfl/captures/2017-05/tapd_10149631_base64_1494314370_68.png)
<br  />
**模版391**效果图：

![图片描述](/tfl/captures/2017-05/tapd_10149631_base64_1494314410_80.png)
<br  />
**模版590**效果图：

![图片描述](/tfl/captures/2017-05/tapd_10149631_base64_1494314447_4.png)
<br  />
**Note:当使用这三个模版时，图层id为1的那个输入源必须传入画布，颜色可以自定义指定**
<br  />
###2.3、自定义位置参数的填写规则说明
<br  />
**示意图：**

![图片描述](/tfl/captures/2017-05/tapd_10149631_base64_1494314657_28.png)
<br  />
从上面的示意图可以看出，需要注意的有以下两点：
<br  />
a、输入的宽高、位置参数全部是像素绝对值。对于不同分辨率的流，需要不同处理。
b、位置参数location_x、location_y为小画面左上角相对背景画面左上角的绝对像素距离。





